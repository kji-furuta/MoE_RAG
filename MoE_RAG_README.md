# MoE-RAG Hybrid Search System

åœŸæœ¨å·¥å­¦å°‚é–€ã®MoEï¼ˆMixture of Expertsï¼‰ã¨RAGï¼ˆRetrieval-Augmented Generationï¼‰ã‚’çµ±åˆã—ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ 

## ğŸŒŸ æ¦‚è¦

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã€ç¶™ç¶šå­¦ç¿’ã€MoEã«ã‚ˆã‚Šå­¦ç¿’ã—ãŸAIãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦ã€RAGã‚·ã‚¹ãƒ†ãƒ ã¨ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚’å®Ÿç¾ã—ã¾ã™ã€‚åœŸæœ¨ãƒ»å»ºè¨­åˆ†é‡ã«ç‰¹åŒ–ã—ãŸ8ã¤ã®å°‚é–€ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãŒã€é«˜ç²¾åº¦ãªå›ç­”ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å°‚é–€ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ
1. **æ§‹é€ è¨­è¨ˆ** - æ§‹é€ è¨ˆç®—ã€è€éœ‡è¨­è¨ˆã€è·é‡è§£æ
2. **é“è·¯è¨­è¨ˆ** - ç·šå½¢è¨­è¨ˆã€è¦–è·ã€è¨­è¨ˆé€Ÿåº¦
3. **åœ°ç›¤å·¥å­¦** - åœŸè³ªèª¿æŸ»ã€æ”¯æŒåŠ›ã€æ¶²çŠ¶åŒ–å¯¾ç­–
4. **æ°´ç†ãƒ»æ’æ°´** - æµé‡è¨ˆç®—ã€æ’æ°´è¨ˆç”»ã€æ²»æ°´
5. **ææ–™å·¥å­¦** - ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã€é‹¼æã€ææ–™è©¦é¨“
6. **æ–½å·¥ç®¡ç†** - å·¥ç¨‹ç®¡ç†ã€å“è³ªç®¡ç†ã€å®‰å…¨ç®¡ç†
7. **æ³•è¦ãƒ»åŸºæº–** - é“è·¯æ§‹é€ ä»¤ã€è¨­è¨ˆåŸºæº–ã€ä»•æ§˜æ›¸
8. **ç’°å¢ƒãƒ»ç¶­æŒç®¡ç†** - ç’°å¢ƒå½±éŸ¿ã€ç¶­æŒç®¡ç†ã€åŠ£åŒ–è¨ºæ–­

## ğŸš€ ä¸»è¦æ©Ÿèƒ½

- **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢**: MoEå°‚é–€çŸ¥è­˜ã¨RAGæ–‡æ›¸æ¤œç´¢ã®èåˆ
- **é©å¿œçš„èåˆ**: ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸæœ€é©ãªçµæœçµ±åˆ
- **ä¸¦åˆ—å‡¦ç†**: MoEã¨RAGã®åŒæ™‚å®Ÿè¡Œã«ã‚ˆã‚‹é«˜é€ŸåŒ–
- **ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢**: ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ä¿¡é ¼åº¦è¨ˆç®—
- **WebSocketå¯¾å¿œ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å›ç­”

## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/kji-furuta/MoE_RAG.git
cd MoE_RAG

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# Dockerã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ï¼ˆæ¨å¥¨ï¼‰
docker-compose up -d
```

## ğŸ¯ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. MoEãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´

```bash
# Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œ
docker exec ai-ft-container bash scripts/moe/train_moe.sh demo 1 2
```

### 2. APIã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

```bash
python app/moe_rag_api.py
```

### 3. Web UIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼š
```
http://localhost:8050/static/moe_rag_ui.html
```

## ğŸ“š APIä½¿ç”¨ä¾‹

### ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¯ã‚¨ãƒª

```python
import requests

response = requests.post(
    "http://localhost:8050/api/moe-rag/query",
    json={
        "query": "è¨­è¨ˆé€Ÿåº¦80km/hã®é“è·¯ã«ãŠã‘ã‚‹æœ€å°æ›²ç·šåŠå¾„ã¯ï¼Ÿ",
        "top_k": 5,
        "use_reranking": True
    }
)

result = response.json()
print(f"å›ç­”: {result['answer']}")
print(f"ä¿¡é ¼åº¦: {result['confidence_score']}")
print(f"é¸æŠã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ: {result['selected_experts']}")
```

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¯ã‚¨ãƒª

```python
import json
import sseclient

response = requests.post(
    "http://localhost:8050/api/moe-rag/stream",
    json={"query": "æ©‹æ¢ã®è€éœ‡è¨­è¨ˆã«ã¤ã„ã¦", "stream": True},
    stream=True
)

client = sseclient.SSEClient(response)
for event in client.events():
    data = json.loads(event.data)
    if data.get('chunk'):
        print(data['chunk'], end='')
```

## ğŸ”§ è¨­å®š

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: `src/moe_rag_integration/config/integration_config.yaml`

```yaml
# MoEè¨­å®š
moe:
  num_experts: 8
  num_experts_per_tok: 2
  
# çµ±åˆè¨­å®š  
integration:
  weights:
    moe: 0.4      # MoEé‡ã¿
    rag: 0.6      # RAGé‡ã¿
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- **æ¨è«–é€Ÿåº¦**: å¹³å‡200ms (P50)
- **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ**: 100 QPS
- **ç²¾åº¦**: å°‚é–€åˆ†é‡è³ªå• 95%ä»¥ä¸Š
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: < 15GB

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

```bash
# çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
python scripts/test_moe_rag_integration.py

# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
pytest tests/
```

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
MoE_RAG/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ moe/                      # MoEãƒ¢ãƒ‡ãƒ«å®Ÿè£…
â”‚   â”œâ”€â”€ moe_rag_integration/      # çµ±åˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ hybrid_query_engine.py
â”‚   â”‚   â”œâ”€â”€ expert_router.py
â”‚   â”‚   â”œâ”€â”€ response_fusion.py
â”‚   â”‚   â””â”€â”€ moe_serving.py
â”‚   â””â”€â”€ rag/                      # RAGã‚·ã‚¹ãƒ†ãƒ 
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ moe_rag_api.py           # FastAPI
â”‚   â””â”€â”€ static/
â”‚       â””â”€â”€ moe_rag_ui.html      # Web UI
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ test_moe_rag_integration.py
â””â”€â”€ docker-compose.yml
```

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ­“è¿ã—ã¾ã™ï¼å¤§ããªå¤‰æ›´ã®å ´åˆã¯ã€ã¾ãšissueã‚’é–‹ã„ã¦å¤‰æ›´å†…å®¹ã‚’è­°è«–ã—ã¦ãã ã•ã„ã€‚

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License

## ğŸ‘¨â€ğŸ’» ä½œè€…

- GitHub: [@kji-furuta](https://github.com/kji-furuta)

## ğŸ™ è¬è¾

- å¸å›½å¤§å­¦ åœŸæœ¨å·¥å­¦ç§‘
- AI Fine-tuning Toolkit ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

---

**æ³¨æ„**: æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ç ”ç©¶ãƒ»é–‹ç™ºç›®çš„ã§ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã®ä½¿ç”¨å‰ã«ååˆ†ãªãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚