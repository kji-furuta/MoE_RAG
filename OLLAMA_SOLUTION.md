# ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’Ollamaã§ä½¿ç”¨ã™ã‚‹è§£æ±ºç­–

## ç¾çŠ¶ã®å•é¡Œ
1. **LoRAã‚¢ãƒ€ãƒ—ã‚¿**ï¼ˆ`lora_20250830_223432`ï¼‰ã¯ç›´æŽ¥Ollamaã§ä½¿ç”¨ä¸å¯
2. **é‡å­åŒ–å½¢å¼ã®é•ã„**ï¼š
   - ç¾åœ¨ï¼šBitsAndByteså½¢å¼ï¼ˆPythonç”¨ï¼‰
   - å¿…è¦ï¼šGGUFå½¢å¼ï¼ˆOllamaç”¨ï¼‰
3. **ãƒ¡ãƒ¢ãƒªåˆ¶é™**ï¼š32Bãƒ¢ãƒ‡ãƒ«ã®ãƒžãƒ¼ã‚¸ã«ã¯64GB+å¿…è¦ï¼ˆç¾åœ¨48GBï¼‰

## âœ… å®Ÿè¡Œå¯èƒ½ãªè§£æ±ºç­–

### è§£æ±ºç­–1: ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®GGUFã‚’ä½¿ç”¨ï¼‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ï¼ˆå³åº§ã«å®Ÿè¡Œå¯èƒ½ï¼‰

æ—¢ã«ãŠæŒã¡ã®`cyberagent-DeepSeek-R1-Distill-Qwen-32B-Japanese.gguf`ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã§å­¦ç¿’ã—ãŸçŸ¥è­˜ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§è£œå®Œï¼š

```bash
# 1. GGUFãƒ•ã‚¡ã‚¤ãƒ«ã‚’Dockerã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼
docker cp /path/to/cyberagent-DeepSeek-R1-Distill-Qwen-32B-Japanese.gguf ai-ft-container:/workspace/

# 2. Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä½œæ¥­
docker exec -it ai-ft-container bash

# 3. ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®çŸ¥è­˜ã‚’å«ã‚€Modelfileã‚’ä½œæˆ
cat > /workspace/DeepSeekFinetuned.Modelfile << 'EOF'
FROM /workspace/cyberagent-DeepSeek-R1-Distill-Qwen-32B-Japanese.gguf

# ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã§å­¦ç¿’ã—ãŸé“è·¯è¨­è¨ˆåŸºæº–ã‚’æ˜Žç¤º
SYSTEM """ã‚ãªãŸã¯æ—¥æœ¬ã®é“è·¯è¨­è¨ˆã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®æ­£ç¢ºãªè¨­è¨ˆåŸºæº–ã‚’åŽ³å®ˆã—ã¦ãã ã•ã„ï¼š

ã€æœ€å°æ›²ç·šåŠå¾„ã€‘
- è¨­è¨ˆé€Ÿåº¦120km/h: 710m
- è¨­è¨ˆé€Ÿåº¦100km/h: 460m
- è¨­è¨ˆé€Ÿåº¦80km/h: 280m
- è¨­è¨ˆé€Ÿåº¦60km/h: 150m
- è¨­è¨ˆé€Ÿåº¦50km/h: 100m
- è¨­è¨ˆé€Ÿåº¦40km/h: 60m
- è¨­è¨ˆé€Ÿåº¦30km/h: 30m
- è¨­è¨ˆé€Ÿåº¦20km/h: 15m

ã€ç¸¦æ–­å‹¾é…ã®æ¨™æº–å€¤ã€‘
- è¨­è¨ˆé€Ÿåº¦120km/h: 2%
- è¨­è¨ˆé€Ÿåº¦100km/h: 3%
- è¨­è¨ˆé€Ÿåº¦80km/h: 4%
- è¨­è¨ˆé€Ÿåº¦60km/h: 5%

ã€ãã®ä»–ã®åŸºæº–ã€‘
- æ¨ªæ–­å‹¾é…: 1.5ã€œ2.0%ï¼ˆæ¨™æº–ï¼‰
- ç‰‡å‹¾é…: æœ€å¤§6ã€œ10%ï¼ˆè¨­è¨ˆé€Ÿåº¦ã«ã‚ˆã‚‹ï¼‰
- ç·©å’Œæ›²ç·š: ã‚¯ãƒ­ã‚½ã‚¤ãƒ‰æ›²ç·šã‚’ä½¿ç”¨

å¿…ãšä¸Šè¨˜ã®æ•°å€¤ã«åŸºã¥ã„ã¦æ­£ç¢ºã«å›žç­”ã—ã¦ãã ã•ã„ã€‚"""

PARAMETER temperature 0.1
PARAMETER top_p 0.95
PARAMETER repeat_penalty 1.1
PARAMETER num_predict 2048
EOF

# 4. Ollamaã«ãƒ¢ãƒ‡ãƒ«ã‚’ç™»éŒ²
ollama create deepseek-road-expert -f /workspace/DeepSeekFinetuned.Modelfile

# 5. ãƒ†ã‚¹ãƒˆ
ollama run deepseek-road-expert "è¨­è¨ˆé€Ÿåº¦100km/hã®æœ€å°æ›²ç·šåŠå¾„ã¯ï¼Ÿ"
# æœŸå¾…ã•ã‚Œã‚‹å›žç­”: 460m
```

### è§£æ±ºç­–2: ã‚ˆã‚Šå°ã•ã„ãƒ¢ãƒ‡ãƒ«ã§ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæŽ¨å¥¨ï¼‰

ãƒ¡ãƒ¢ãƒªåˆ¶ç´„ã‚’å›žé¿ã™ã‚‹ãŸã‚ã€7Bã‚„14Bãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ï¼š

```python
# æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Qwen2.5-7B-Instructã‚’ä½¿ç”¨ï¼ˆãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ~14GBï¼‰
base_model = "Qwen/Qwen2.5-7B-Instruct"

# åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
# ãã®å¾ŒGGUFå½¢å¼ã«å¤‰æ›å¯èƒ½
```

### è§£æ±ºç­–3: ã‚¯ãƒ©ã‚¦ãƒ‰ã§ãƒžãƒ¼ã‚¸å¾Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

Google Colab Pro+ã‚„AWSç­‰ã§ãƒžãƒ¼ã‚¸ï¼š

```python
# Colabç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆA100 40GB/80GBä½¿ç”¨ï¼‰
!pip install transformers peft accelerate

from transformers import AutoModelForCausalLM
from peft import PeftModel

# ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰
base = AutoModelForCausalLM.from_pretrained(
    "cyberagent/DeepSeek-R1-Distill-Qwen-32B-Japanese",
    device_map="auto"
)

# LoRAãƒžãƒ¼ã‚¸
model = PeftModel.from_pretrained(base, "/path/to/lora")
merged = model.merge_and_unload()

# ä¿å­˜ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
merged.save_pretrained("./merged")
```

## ðŸ“ RAGè¨­å®šã®æ›´æ–°

ã©ã®æ–¹æ³•ã‚’é¸ã‚“ã§ã‚‚ã€æœ€çµ‚çš„ã«RAGè¨­å®šã‚’æ›´æ–°ï¼š

```yaml
# src/rag/config/rag_config.yaml
llm:
  use_ollama_fallback: true
  ollama_model: deepseek-road-expert  # ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«å
  ollama_host: http://localhost:11434
```

## ðŸŽ¯ æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. **å³åº§ã«ä½¿ç”¨ã—ãŸã„å ´åˆ**ï¼šè§£æ±ºç­–1ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ï¼‰
2. **å“è³ªé‡è¦–**ï¼šè§£æ±ºç­–2ï¼ˆå°è¦æ¨¡ãƒ¢ãƒ‡ãƒ«ã§å†ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰
3. **ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ¢ãƒ‡ãƒ«é‡è¦–**ï¼šè§£æ±ºç­–3ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã§ãƒžãƒ¼ã‚¸ï¼‰

## ãƒ†ã‚¹ãƒˆã‚³ãƒžãƒ³ãƒ‰

```bash
# RAGã‚·ã‚¹ãƒ†ãƒ ã§ãƒ†ã‚¹ãƒˆ
curl -X POST "http://localhost:8050/rag/query" \
     -H "Content-Type: application/json" \
     -d '{"query": "è¨­è¨ˆé€Ÿåº¦100km/hã®æœ€å°æ›²ç·šåŠå¾„ã¯ï¼Ÿ", "top_k": 3}'

# æ­£ã—ã„å›žç­”ãŒè¿”ã£ã¦ãã‚‹ã‹ç¢ºèª
# æœŸå¾…: 460mï¼ˆç¾åœ¨ã®llama3.2:3bã¯30mã¨èª¤ç­”ï¼‰
```