{% extends "base.html" %}

{% block title %}ç¶™ç¶šå­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_styles %}
<style>
    .continual-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .tabs {
        display: flex;
        background: #f5f5f5;
        border-radius: 8px;
        margin-bottom: 20px;
        padding: 5px;
    }

    .tab {
        flex: 1;
        padding: 12px 20px;
        cursor: pointer;
        background: transparent;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s;
        text-align: center;
        color: #666;
    }

    .tab:hover {
        background: rgba(52, 152, 219, 0.1);
    }

    .tab.active {
        background: white;
        color: #2c3e50;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.5rem;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #2c3e50;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3498db;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #95a5a6;
        color: white;
        margin-left: 10px;
    }

    .btn-secondary:hover {
        background: #7f8c8d;
    }

    .task-item {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }

    .task-item h4 {
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
    }

    .status-running {
        background: #f39c12;
        color: white;
    }

    .status-completed {
        background: #27ae60;
        color: white;
    }

    .status-failed {
        background: #e74c3c;
        color: white;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
</style>
{% endblock %}

{% block main_title %}
<h1>
    <img src="/static/logo_teikoku.png" alt="Logo" class="title-logo">
    ğŸ”„ ç¶™ç¶šå­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
</h1>
<p>EWCãƒ™ãƒ¼ã‚¹ã®ç¶™ç¶šå­¦ç¿’ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«ã®æ®µéšçš„ãªæ”¹å–„</p>
{% endblock %}

{% block content %}
<div class="continual-container">
    <div class="card">
        <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('training')">
                ğŸ“ æ–°è¦å­¦ç¿’
            </button>
            <button class="tab" onclick="switchTab('tasks')">
                ğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§
            </button>
            <button class="tab" onclick="switchTab('history')">
                ğŸ“Š å­¦ç¿’å±¥æ­´
            </button>
        </div>

        <!-- æ–°è¦å­¦ç¿’ã‚¿ãƒ– -->
        <div id="training-tab" class="tab-content active">
            <h2>æ–°ã—ã„ç¶™ç¶šå­¦ç¿’ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹</h2>

            
            <form id="continualLearningForm">
                <div class="grid">
                    <div class="form-group">
                        <label for="baseModel">ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«:</label>
                        <select id="baseModel" required>
                            <option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                        <small id="modelInfo" style="color: #666; font-size: 12px;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskName">ã‚¿ã‚¹ã‚¯å:</label>
                        <input type="text" id="taskName" required placeholder="ä¾‹: specialized_domain_task">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="dataset">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ (JSONLå½¢å¼):</label>
                    <input type="file" id="dataset" accept=".jsonl" required>
                </div>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="ewcLambda">EWCé‡è¦åº¦ (Î»):</label>
                        <input type="number" id="ewcLambda" value="5000" min="0" step="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="epochs">ã‚¨ãƒãƒƒã‚¯æ•°:</label>
                        <input type="number" id="epochs" value="3" min="1" max="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="learningRate">å­¦ç¿’ç‡:</label>
                        <input type="number" id="learningRate" value="0.00002" min="0" step="0.000001">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="usePreviousTasks" checked>
                        ä»¥å‰ã®ã‚¿ã‚¹ã‚¯ã®Fisherè¡Œåˆ—ã‚’ä½¿ç”¨ï¼ˆç ´æ»…çš„å¿˜å´ã®é˜²æ­¢ï¼‰
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">ğŸš€ ç¶™ç¶šå­¦ç¿’ã‚’é–‹å§‹</button>
                <button type="button" class="btn btn-secondary" onclick="window.refreshModels(); return false;">ğŸ”„ ãƒ¢ãƒ‡ãƒ«æ›´æ–°</button>
            </form>
            
            <div id="currentTaskStatus" style="margin-top: 20px;">
                <!-- ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚¿ãƒ– -->
        <div id="tasks-tab" class="tab-content">
            <h2>å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯</h2>
            <div id="taskList">
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <!-- å­¦ç¿’å±¥æ­´ã‚¿ãƒ– -->
        <div id="history-tab" class="tab-content">
            <h2>å­¦ç¿’å±¥æ­´</h2>
            <div id="taskHistory">
                <p>å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentTaskId = null;

// ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ï¼‰
window.refreshModels = async function() {
    console.log('refreshModelsé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
    
    try {
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const select = document.getElementById('baseModel');
        if (!select) {
            console.error('baseModelè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            showAlert('ã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ‡ãƒ«é¸æŠãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
        }
        
        console.log('APIã‚’å‘¼ã³å‡ºã—ä¸­: /api/continual-learning/models');
        const response = await fetch('/api/continual-learning/models');
        
        console.log(`APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const models = await response.json();
        console.log('å–å¾—ã—ãŸãƒ¢ãƒ‡ãƒ«ä¸€è¦§:', models);
        console.log(`ãƒ¢ãƒ‡ãƒ«æ•°: ${models ? models.length : 0}`);

        
        // ç¾åœ¨ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
        select.innerHTML = '<option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        console.log('é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        
        if (models && models.length > 0) {
            // ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ—
            const baseModels = models.filter(m => m.type === 'base');
            console.log(`ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«æ•°: ${baseModels.length}`);
            
            if (baseModels.length > 0) {
                const baseGroup = document.createElement('optgroup');
                baseGroup.label = 'ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«';
                baseModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.path;
                    option.textContent = model.name;
                    if (model.description) {
                        option.textContent += ` - ${model.description}`;
                    }
                    baseGroup.appendChild(option);
                    console.log(`ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«è¿½åŠ : ${model.name}`);
                });
                select.appendChild(baseGroup);
                console.log('ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ—
            const fineTunedModels = models.filter(m => m.type === 'finetuned');
            console.log(`ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«æ•°: ${fineTunedModels.length}`);
            
            if (fineTunedModels.length > 0) {
                const ftGroup = document.createElement('optgroup');
                ftGroup.label = 'ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«';
                fineTunedModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.path;
                    option.textContent = model.name;
                    ftGroup.appendChild(option);
                    console.log(`FTãƒ¢ãƒ‡ãƒ«è¿½åŠ : ${model.name}`);
                });
                select.appendChild(ftGroup);
                console.log('ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }
            
            // ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                modelInfo.textContent = `${models.length}å€‹ã®ãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨å¯èƒ½ã§ã™ (ãƒ™ãƒ¼ã‚¹: ${baseModels.length}å€‹, FTæ¸ˆã¿: ${fineTunedModels.length}å€‹)`;
                console.log('ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            }
            
            // æœ€çµ‚çš„ãªé¸æŠè‚¢æ•°ã‚’ç¢ºèª
            console.log(`æœ€çµ‚çš„ãªé¸æŠè‚¢æ•°: ${select.options.length}`);
            console.log(`optgroupæ•°: ${select.getElementsByTagName('optgroup').length}`);
        } else {
            console.warn('ãƒ¢ãƒ‡ãƒ«ãŒ0å€‹ã¾ãŸã¯nullã§ã™');
            showAlert('åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
        }
    } catch (error) {
        console.error('ãƒ¢ãƒ‡ãƒ«ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
        showAlert(`ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
    }
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
window.addEventListener('DOMContentLoaded', function() {
    console.log('ç¶™ç¶šå­¦ç¿’ãƒšãƒ¼ã‚¸: DOMèª­ã¿è¾¼ã¿å®Œäº†');
    
    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã€ã™ã¹ã¦ã®è¦ç´ ãŒç¢ºå®Ÿã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
    setTimeout(function() {
        console.log('ç¶™ç¶šå­¦ç¿’ãƒšãƒ¼ã‚¸: åˆæœŸåŒ–é–‹å§‹');
        
        // baseModelè¦ç´ ã®å­˜åœ¨ç¢ºèª
        const baseModelElement = document.getElementById('baseModel');
        if (!baseModelElement) {
            console.error('ã‚¨ãƒ©ãƒ¼: baseModelè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            console.log('ç¾åœ¨ã®HTMLæ§‹é€ :', document.getElementById('training-tab')?.innerHTML.substring(0, 500));
        } else {
            console.log('baseModelè¦ç´ ã‚’ç¢ºèª:', baseModelElement);
            
            // ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’æ›´æ–°
            window.refreshModels();

            
            // ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            baseModelElement.addEventListener('change', updateModelInfo);
        }
        
        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        loadTasks();
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚µãƒ–ãƒŸãƒƒãƒˆå‡¦ç†
        const form = document.getElementById('continualLearningForm');
        if (form) {
            form.addEventListener('submit', startContinualLearning);
            console.log('ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
        } else {
            console.error('ã‚¨ãƒ©ãƒ¼: continualLearningFormãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        // å®šæœŸçš„ãªã‚¿ã‚¹ã‚¯æ›´æ–°
        setInterval(loadTasks, 5000);
    }, 100);
});

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchTab(tabName) {
    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // å±¥æ­´ã‚¿ãƒ–ã®å ´åˆã¯å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
    if (tabName === 'history') {
        loadHistory();
    }
}

// ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ã®æƒ…å ±è¡¨ç¤º
function updateModelInfo() {
    const baseModel = document.getElementById('baseModel');
    const modelInfo = document.getElementById('modelInfo');
    
    if (baseModel.value) {
        fetch('/api/continual-learning/models')
            .then(response => response.json())
            .then(models => {
                const selectedModel = models.find(m => m.path === baseModel.value);
                if (selectedModel) {
                    modelInfo.textContent = `ã‚¿ã‚¤ãƒ—: ${selectedModel.type}, èª¬æ˜: ${selectedModel.description || 'ãªã—'}`;
                }
            })
            .catch(error => {
                modelInfo.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            });
    } else {
        modelInfo.textContent = '';
    }
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
async function loadTasks() {
    try {
        const response = await fetch('/api/continual-learning/tasks');
        if (response.ok) {
            const tasks = await response.json();
            updateTaskList(tasks);
        }
    } catch (error) {
        console.error('ã‚¿ã‚¹ã‚¯ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
function updateTaskList(tasks) {
    const taskList = document.getElementById('taskList');
    if (!taskList) return;
    
    if (tasks && tasks.length > 0) {
        taskList.innerHTML = tasks.map(function(task) {
            return '<div class="task-item">' +
                '<h4>' + task.task_name + '</h4>' +
                '<p>çŠ¶æ…‹: ' + task.status + '</p>' +
                '<p>é€²æ—: ' + (task.progress || 0) + '%</p>' +
                '<p>é–‹å§‹æ™‚åˆ»: ' + task.started_at + '</p>' +
            '</div>';
        }).join('');
    } else {
        taskList.innerHTML = '<p>å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
    }
}

// å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
async function loadHistory() {
    try {
        const response = await fetch('/api/continual-learning/history');
        if (response.ok) {
            const history = await response.json();
            updateHistoryList(history);
        }
    } catch (error) {
        console.error('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// å±¥æ­´ä¸€è¦§ã‚’æ›´æ–°
function updateHistoryList(history) {
    const taskHistory = document.getElementById('taskHistory');
    if (!taskHistory) return;
    
    if (history && history.length > 0) {
        taskHistory.innerHTML = history.map(function(task) {
            return '<div class="task-item">' +
                '<h4>' + task.task_name + '</h4>' +
                '<p>çŠ¶æ…‹: ' + task.status + '</p>' +
                '<p>å®Œäº†æ™‚åˆ»: ' + (task.completed_at || 'æœªå®Œäº†') + '</p>' +
            '</div>';
        }).join('');
    } else {
        taskHistory.innerHTML = '<p>å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
    }
}

// ç¶™ç¶šå­¦ç¿’ã‚’é–‹å§‹
async function startContinualLearning(event) {
    event.preventDefault();
    
    // å…¥åŠ›æ¤œè¨¼
    const baseModel = document.getElementById('baseModel').value;
    const taskName = document.getElementById('taskName').value;
    const datasetFile = document.getElementById('dataset').files[0];
    
    if (!baseModel) {
        showAlert('ã‚¨ãƒ©ãƒ¼: ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
    }
    
    if (!taskName) {
        showAlert('ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }
    
    if (!datasetFile) {
        showAlert('ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
    }
    
    const formData = new FormData();
    const config = {
        base_model: baseModel,
        task_name: taskName,
        use_previous_tasks: document.getElementById('usePreviousTasks').checked,
        ewc_lambda: parseFloat(document.getElementById('ewcLambda').value),
        epochs: parseInt(document.getElementById('epochs').value),
        learning_rate: parseFloat(document.getElementById('learningRate').value),
        use_memory_efficient: true
    };
    
    formData.append('config', JSON.stringify(config));
    formData.append('dataset', datasetFile);
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const submitButton = event.target.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'ğŸ”„ å‡¦ç†ä¸­...';
    
    try {
        const response = await fetch('/api/continual-learning/start', {
            method: 'POST',
            body: formData
        });
        
        const responseData = await response.json();
        
        if (!response.ok) {
            throw new Error(responseData.detail || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
        
        currentTaskId = responseData.task_id;
        showAlert('âœ… ' + responseData.message, 'success');
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('continualLearningForm').reset();
        
        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab')[1].click();
        
        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
        loadTasks();
        
    } catch (error) {
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        showAlert('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    } finally {
        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
        submitButton.disabled = false;
        submitButton.textContent = 'ğŸš€ ç¶™ç¶šå­¦ç¿’ã‚’é–‹å§‹';
    }
}

// ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
function showAlert(message, type) {
    const statusDiv = document.getElementById('currentTaskStatus');
    const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
    statusDiv.innerHTML = '<div class="alert ' + alertClass + '">' + message + '</div>';
}
{% endblock %}