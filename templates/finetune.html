{% extends "base.html" %}

{% block title %}Fine-tuning - AI Fine-tuning & Text Generation System{% endblock %}

{% block extra_styles %}
.nav {
    background: #f8f9fa;
    padding: 15px 30px;
    border-bottom: 1px solid #e0e0e0;
}
.nav a {
    color: #667eea;
    text-decoration: none;
    margin-right: 20px;
    font-weight: 500;
}
.nav a:hover {
    text-decoration: underline;
}
.section {
    background: #f8f9ff;
    border-left: 4px solid #667eea;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
}
.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
}
.status-running {
    background: #4CAF50;
    animation: pulse 1s infinite;
}
.status-completed {
    background: #2196F3;
}
.status-error {
    background: #f44336;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
{% endblock %}

{% block main_title %}
<h1>
    <img src="/static/logo_teikoku.png" alt="Logo" class="title-logo">
    üñ•Ô∏è Fine-tuning Interface</h1>
<p>Fine-tune models with custom datasets</p>
{% endblock %}

{% block content %}
<div class="container">
    <div class="nav">
        <a href="/">üè† Home</a>
        <a href="/models">üìã Model List</a>
        <a href="/finetune">üéØ Fine-tuning</a>
    </div>
    
    <div class="content">
        <!-- „Éá„Éº„Çø„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="section">
            <h2>üìÅ Data Upload</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="trainingData">Training Data (JSONL/JSON):</label>
                    <input type="file" id="trainingData" name="file" accept=".jsonl,.json" required>
                </div>
                <button type="submit" class="btn">üì§ Upload Data</button>
            </form>
            <div id="uploadResult"></div>
        </div>
        
        <!-- „Éï„Ç°„Ç§„É≥„ÉÅ„É•„Éº„Éã„É≥„Ç∞Ë®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="section">
            <h2>‚öôÔ∏è Fine-tuning Configuration</h2>
            <form id="trainingForm">
                <div class="form-group">
                    <label for="baseModel">Base Model:</label>
                    <select id="baseModel" name="baseModel" required>
                        <option value="">Select a base model...</option>
                        <optgroup label="Small Models (Fast Training)">
                            <option value="stabilityai/japanese-stablelm-3b-4e1t-instruct">Japanese StableLM 3B Instruct</option>
                            <option value="elyza/ELYZA-japanese-Llama-2-7b-instruct">ELYZA Japanese Llama-2 7B Instruct</option>
                            <option value="microsoft/Phi-3.5-mini-instruct">Microsoft Phi-3.5 Mini Instruct (3.8B)</option>
                        </optgroup>
                        <optgroup label="Medium Models (Recommended)">
                            <option value="stabilityai/japanese-stablelm-instruct-alpha-7b-v2">Japanese StableLM Instruct Alpha 7B v2</option>
                            <option value="tokyotech-llm/Swallow-7b-instruct-hf">Swallow 7B Instruct Japanese</option>
                            <option value="elyza/ELYZA-japanese-Llama-2-13b-instruct">ELYZA Japanese Llama-2 13B Instruct</option>
                        </optgroup>
                        <optgroup label="Large Models (High Performance)">
                            <option value="tokyotech-llm/Swallow-13b-instruct-hf">Swallow 13B Instruct Japanese</option>
                            <option value="Qwen/Qwen2.5-14B-Instruct">Qwen 2.5 14B Instruct</option>
                            <option value="microsoft/Orca-2-13b">Microsoft Orca-2 13B</option>
                        </optgroup>
                        <optgroup label="Very Large Models (High Performance)">
                            <option value="Qwen/Qwen2.5-32B-Instruct">Qwen 2.5 32B Instruct</option>
                            <option value="cyberagent/DeepSeek-R1-Distill-Qwen-32B-Japanese">CyberAgent DeepSeek-R1 Distill Qwen 32B Japanese</option>
                            <option value="meta-llama/Llama-3.1-8B-Instruct">Meta Llama 3.1 8B Instruct</option>
                        </optgroup>
                        <optgroup label="Ultra Large Models (Maximum Performance)">
                            <option value="tokyotech-llm/Swallow-70b-instruct-hf">Swallow 70B Instruct Japanese</option>
                            <option value="microsoft/WizardLM-2-8x22B">WizardLM-2 8x22B</option>
                            <option value="meta-llama/Llama-3.1-70B-Instruct">Meta Llama 3.1 70B Instruct</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="trainingMethod">Training Method:</label>
                    <select id="trainingMethod" name="trainingMethod" required>
                        <option value="qlora">QLoRA (Recommended)</option>
                        <option value="lora">LoRA</option>
                        <option value="full">Full Fine-tuning</option>
                    </select>
                </div>
                
                <div id="loraConfig" style="display: none;">
                    <h3>LoRA/QLoRA Configuration</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="loraR">LoRA Rank (r):</label>
                            <input type="number" id="loraR" name="loraR" value="16" min="1" max="256">
                        </div>
                        <div class="form-group">
                            <label for="loraAlpha">LoRA Alpha:</label>
                            <input type="number" id="loraAlpha" name="loraAlpha" value="32" min="1" max="512">
                        </div>
                        <div class="form-group">
                            <label for="loraDropout">LoRA Dropout:</label>
                            <input type="number" id="loraDropout" name="loraDropout" value="0.1" min="0" max="1" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="learningRate">Learning Rate:</label>
                        <input type="number" id="learningRate" name="learningRate" value="2e-4" min="1e-6" max="1e-2" step="1e-6">
                    </div>
                    <div class="form-group">
                        <label for="numEpochs">Number of Epochs:</label>
                        <input type="number" id="numEpochs" name="numEpochs" value="3" min="1" max="10">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="batchSize">Batch Size:</label>
                        <input type="number" id="batchSize" name="batchSize" value="4" min="1" max="16">
                    </div>
                    <div class="form-group">
                        <label for="maxLength">Max Sequence Length:</label>
                        <input type="number" id="maxLength" name="maxLength" value="512" min="128" max="2048">
                    </div>
                </div>
                
                <button type="submit" class="btn">üöÄ Start Training</button>
            </form>
        </div>
        
        <!-- „Éà„É¨„Éº„Éã„É≥„Ç∞Áä∂Ê≥Å„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="section">
            <h2>üìä Training Status</h2>
            <div id="trainingStatus">
                <p>No training in progress</p>
            </div>
            <div id="trainingProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p id="progressText">0%</p>
            </div>
        </div>
        
        <!-- LoRA„Ç¢„ÉÄ„Éó„Çø„ÉºÈÅ©Áî®„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="section">
            <h2>üîÑ Apply LoRA Adapter to GGUF Model</h2>
            <p>Convert your fine-tuned LoRA adapter to Ollama format for use with GGUF base models.</p>
            
            <form id="loraApplyForm">
                <div class="form-group">
                    <label for="baseModelSelect">Base Model (GGUF):</label>
                    <select id="baseModelSelect" name="baseModelSelect" required>
                        <option value="deepseek-32b">DeepSeek-R1-Distill-Qwen-32B (Q4_K_M)</option>
                        <option value="custom">Custom Model URL</option>
                    </select>
                </div>
                
                <div id="customModelUrlDiv" style="display: none;">
                    <div class="form-group">
                        <label for="customModelUrl">Custom Model URL:</label>
                        <input type="url" id="customModelUrl" name="customModelUrl" 
                               placeholder="https://huggingface.co/model/resolve/main/model.gguf">
                    </div>
                    <div class="form-group">
                        <label for="customModelName">Model File Name:</label>
                        <input type="text" id="customModelName" name="customModelName" 
                               placeholder="model_name.gguf">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="loraAdapterSelect">Select Fine-tuned LoRA Model:</label>
                    <select id="loraAdapterSelect" name="loraAdapterSelect" required>
                        <option value="">Loading models...</option>
                    </select>
                    <small>Select a fine-tuned LoRA adapter from your training sessions</small>
                </div>
                
                <div id="loraModelInfo" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9ff; border-left: 3px solid #667eea;">
                    <h4 style="margin: 0 0 5px 0;">Model Details:</h4>
                    <div id="loraModelDetails"></div>
                </div>
                
                <div class="form-group">
                    <label for="outputModelName">Output Model Name:</label>
                    <input type="text" id="outputModelName" name="outputModelName" 
                           value="deepseek-32b-finetuned" required>
                    <small>This will be the name used in Ollama (e.g., ollama run deepseek-32b-finetuned)</small>
                </div>
                
                <button type="submit" class="btn">üöÄ Apply LoRA & Register to Ollama</button>
            </form>
            
            <div id="loraApplyResult" style="margin-top: 20px;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// „Éà„É¨„Éº„Éã„É≥„Ç∞ÊñπÊ≥ï„ÅÆÂ§âÊõ¥„Å´Âøú„Åò„Å¶UI„ÇíÊõ¥Êñ∞
document.getElementById('trainingMethod').addEventListener('change', function() {
    const loraConfig = document.getElementById('loraConfig');
    const learningRate = document.getElementById('learningRate');
    
    if (this.value === 'qlora' || this.value === 'lora') {
        loraConfig.style.display = 'block';
        learningRate.value = '2e-4';
    } else {
        loraConfig.style.display = 'none';
        learningRate.value = '5e-5';
    }
});

// „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±„ÇíÂèñÂæó
async function loadSystemInfo() {
    try {
        const response = await fetch('/api/system-info');
        const data = await response.json();
        
        if (data.error) {
            document.getElementById('systemInfo').innerHTML = `<p>Error: ${data.error}</p>`;
            return;
        }
        
        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
        
        if (data.gpu) {
            html += `
                <div>
                    <h3>GPU Information</h3>
                    <p><strong>Name:</strong> ${data.gpu.name || 'Unknown'}</p>
                    <p><strong>Memory:</strong> ${data.gpu.memory || 'Unknown'}</p>
                    <p><strong>Available:</strong> ${data.gpu.available ? 'Yes' : 'No'}</p>
                </div>
            `;
        }
        
        if (data.cuda) {
            html += `
                <div>
                    <h3>CUDA Information</h3>
                    <p><strong>Available:</strong> ${data.cuda.available ? 'Yes' : 'No'}</p>
                    <p><strong>Version:</strong> ${data.cuda.version || 'Unknown'}</p>
                </div>
            `;
        }
        
        if (data.pytorch) {
            html += `
                <div>
                    <h3>PyTorch Information</h3>
                    <p><strong>Version:</strong> ${data.pytorch.version || 'Unknown'}</p>
                </div>
            `;
        }
        
        if (data.cpu) {
            html += `
                <div>
                    <h3>CPU Information</h3>
                    <p><strong>Name:</strong> ${data.cpu.name || 'Unknown'}</p>
                    <p><strong>Cores:</strong> ${data.cpu.cores || 'Unknown'}</p>
                </div>
            `;
        }
        
        html += '</div>';
        document.getElementById('systemInfo').innerHTML = html;
        
    } catch (error) {
        console.error('Error loading system info:', error);
        document.getElementById('systemInfo').innerHTML = '<p>Failed to load system information</p>';
    }
}

// „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ„Çí‰øùÂ≠ò
let uploadedFilePath = null;

// „Éá„Éº„Çø„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('trainingData');
    formData.append('file', fileInput.files[0]);
    
    const resultDiv = document.getElementById('uploadResult');
    resultDiv.innerHTML = '<p>Uploading...</p>';
    
    try {
        const response = await fetch('/api/upload-data', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // ÊàêÂäü„ÄÅË≠¶Âëä„ÄÅ„Ç®„É©„Éº„ÅßÁï∞„Å™„ÇãË°®Á§∫
            let bgColor, textColor, title;
            if (result.status === 'success') {
                bgColor = '#d4edda';
                textColor = '#155724';
                title = '„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäüÔºÅ';
            } else if (result.status === 'warning') {
                bgColor = '#fff3cd';
                textColor = '#856404';
                title = '„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫ÜÔºàË≠¶Âëä„ÅÇ„ÇäÔºâ';
            } else {
                bgColor = '#f8d7da';
                textColor = '#721c24';
                title = '„Éá„Éº„ÇøÊ§úË®º„Ç®„É©„Éº';
            }
            
            let html = `
                <div style="background: ${bgColor}; color: ${textColor}; padding: 15px; border-radius: 5px; margin-top: 10px;">
                    <h3>${title}</h3>
                    <p><strong>„Éï„Ç°„Ç§„É´Âêç:</strong> ${result.filename}</p>
                    <p><strong>Á∑èË°åÊï∞:</strong> ${result.data_count}</p>
                    <p><strong>ÊúâÂäπ„Å™Ë°åÊï∞:</strong> ${result.valid_lines || result.data_count}</p>
            `;
            
            // „Ç®„É©„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË©≥Á¥∞„ÇíË°®Á§∫
            if (result.error_count > 0) {
                html += `
                    <p><strong>„Ç®„É©„ÉºË°åÊï∞:</strong> ${result.error_count} (${result.error_rate || '0%'})</p>
                `;
                
                if (result.fallback_warning) {
                    html += `<p style="color: red; font-weight: bold;">‚ö†Ô∏è ${result.fallback_warning}</p>`;
                } else if (result.warning) {
                    html += `<p style="color: orange; font-weight: bold;">‚ö†Ô∏è ${result.warning}</p>`;
                }
                
                // „Ç®„É©„Éº„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
                if (result.errors && result.errors.length > 0) {
                    html += '<div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 3px;">';
                    html += '<strong>„Ç®„É©„ÉºË©≥Á¥∞ÔºàÊúÄÂàù„ÅÆ10‰ª∂Ôºâ:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                    result.errors.forEach(err => {
                        html += `<li>Ë°å ${err.line}: ${err.error}</li>`;
                    });
                    html += '</ul></div>';
                }
            }
            
            html += `
                    <p><strong>„Çµ„Ç§„Ç∫:</strong> ${result.size} bytes</p>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            
            // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäüÊôÇ„Å´„Éï„Ç°„Ç§„É´„Éë„Çπ„Çí‰øùÂ≠ò
            if (result.path) {
                uploadedFilePath = result.path;
                console.log('Uploaded file path saved:', uploadedFilePath);
            }
        } else {
            resultDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 10px;">
                    <h3>Upload Failed</h3>
                    <p>${result.detail}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Upload error:', error);
        resultDiv.innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 10px;">
                <h3>Upload Error</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
});

// „Éà„É¨„Éº„Éã„É≥„Ç∞ÈñãÂßãÂá¶ÁêÜ
document.getElementById('trainingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    // „Éá„Éº„Çø„ÅÆÊ§úË®º
    const modelName = formData.get('baseModel');
    const trainingMethod = formData.get('trainingMethod');
    
    if (!modelName) {
        alert('Please select a base model');
        return;
    }
    
    console.log('Training data:', {
        model_name: modelName,
        training_method: trainingMethod,
        lora_config: {
            r: parseInt(formData.get('loraR')),
            alpha: parseInt(formData.get('loraAlpha')),
            dropout: parseFloat(formData.get('loraDropout'))
        },
        training_config: {
            learning_rate: parseFloat(formData.get('learningRate')),
            num_epochs: parseInt(formData.get('numEpochs')),
            batch_size: parseInt(formData.get('batchSize')),
            max_length: parseInt(formData.get('maxLength'))
        }
    });
    
    // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„Éë„Çπ„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà„Éë„Çπ
    const dataPath = uploadedFilePath || "/workspace/data/uploaded/training_data.jsonl";
    
    const trainingData = {
        model_name: modelName,
        training_method: trainingMethod,
        training_data: [dataPath], // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ„Çí‰ΩøÁî®
        lora_config: {
            r: parseInt(formData.get('loraR')),
            alpha: parseInt(formData.get('loraAlpha')),
            dropout: parseFloat(formData.get('loraDropout'))
        },
        training_config: {
            learning_rate: parseFloat(formData.get('learningRate')),
            num_epochs: parseInt(formData.get('numEpochs')),
            batch_size: parseInt(formData.get('batchSize')),
            max_length: parseInt(formData.get('maxLength'))
        }
    };
    
    const statusDiv = document.getElementById('trainingStatus');
    const progressDiv = document.getElementById('trainingProgress');
    
    statusDiv.innerHTML = '<p>Starting training...</p>';
    progressDiv.style.display = 'block';
    
    try {
        console.log('Sending training request:', trainingData);
        
        const response = await fetch('/api/train', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(trainingData)
        });
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response result:', result);
        
        if (response.ok) {
            statusDiv.innerHTML = `
                <p><span class="status-indicator status-running"></span>Training started (Task ID: ${result.task_id})</p>
            `;
            
            // ÂÆöÊúüÁöÑ„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            checkTrainingStatus(result.task_id);
        } else {
            statusDiv.innerHTML = `
                <p><span class="status-indicator status-error"></span>Training failed: ${result.detail || result.message || 'Unknown error'}</p>
            `;
            progressDiv.style.display = 'none';
        }
    } catch (error) {
        console.error('Training error:', error);
        statusDiv.innerHTML = `
            <p><span class="status-indicator status-error"></span>Training error: ${error.message}</p>
        `;
        progressDiv.style.display = 'none';
    }
});

// „Éà„É¨„Éº„Éã„É≥„Ç∞„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
async function checkTrainingStatus(taskId) {
    try {
        const response = await fetch(`/api/training-status/${taskId}`);
        const status = await response.json();
        
        const statusDiv = document.getElementById('trainingStatus');
        const progressDiv = document.getElementById('trainingProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        if (status.status === 'completed') {
            statusDiv.innerHTML = `
                <p><span class="status-indicator status-completed"></span>Training completed!</p>
                <p><strong>Model saved to:</strong> ${status.model_path || 'Unknown'}</p>
            `;
            progressDiv.style.display = 'none';
        } else if (status.status === 'error') {
            statusDiv.innerHTML = `
                <p><span class="status-indicator status-error"></span>Training failed: ${status.message}</p>
            `;
            progressDiv.style.display = 'none';
        } else {
            statusDiv.innerHTML = `
                <p><span class="status-indicator status-running"></span>${status.message}</p>
            `;
            progressFill.style.width = `${status.progress}%`;
            progressText.textContent = `${Math.round(status.progress)}%`;
            
            // 1ÁßíÂæå„Å´ÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
            setTimeout(() => checkTrainingStatus(taskId), 1000);
        }
    } catch (error) {
        console.error('Status check error:', error);
    }
}

// „Éï„Ç°„Ç§„É≥„ÉÅ„É•„Éº„Éã„É≥„Ç∞Ê∏à„ÅøLoRA„É¢„Éá„É´„ÇíË™≠„ÅøËæº„ÇÄ
async function loadFinetunedLoRAModels() {
    try {
        const response = await fetch('/api/finetuned-lora-models');
        const data = await response.json();
        
        const selectElement = document.getElementById('loraAdapterSelect');
        selectElement.innerHTML = '';
        
        if (data.success && data.models && data.models.length > 0) {
            // „Éá„Éï„Ç©„É´„Éà„Ç™„Éó„Ç∑„Éß„É≥
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a fine-tuned model...';
            selectElement.appendChild(defaultOption);
            
            // ÊúÄÊñ∞„ÅÆ„É¢„Éá„É´„ÇíËá™ÂãïÈÅ∏ÊäûÁî®„Å´„Éû„Éº„ÇØ
            const latestOption = document.createElement('option');
            latestOption.value = 'latest';
            latestOption.textContent = 'üìå Use Latest Model (Auto-detect)';
            selectElement.appendChild(latestOption);
            
            // ÂêÑ„É¢„Éá„É´„Çí„Ç™„Éó„Ç∑„Éß„É≥„Å®„Åó„Å¶ËøΩÂä†
            data.models.forEach((model, index) => {
                const option = document.createElement('option');
                option.value = model.path;
                option.dataset.modelInfo = JSON.stringify(model);
                
                // „É¢„Éá„É´Âêç„ÅÆË°®Á§∫„ÇíÊï¥ÂΩ¢
                const baseModelName = model.base_model ? 
                    model.base_model.split('/').pop() : 'Unknown Base';
                const displayName = `${model.name} (${baseModelName}) - ${model.created}`;
                
                option.textContent = displayName;
                
                // ÊúÄÂàù„ÅÆ„É¢„Éá„É´„Å´„ÅØNew„Éê„ÉÉ„Ç∏„Çí‰ªò„Åë„Çã
                if (index === 0) {
                    option.textContent = 'üÜï ' + displayName;
                }
                
                selectElement.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No fine-tuned models found';
            selectElement.appendChild(option);
        }
    } catch (error) {
        console.error('Error loading finetuned models:', error);
        const selectElement = document.getElementById('loraAdapterSelect');
        selectElement.innerHTML = '<option value="">Error loading models</option>';
    }
}

// „É¢„Éá„É´ÈÅ∏ÊäûÊôÇ„Å´Ë©≥Á¥∞„ÇíË°®Á§∫
document.getElementById('loraAdapterSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const infoDiv = document.getElementById('loraModelInfo');
    const detailsDiv = document.getElementById('loraModelDetails');
    
    if (selectedOption && selectedOption.dataset.modelInfo) {
        const modelInfo = JSON.parse(selectedOption.dataset.modelInfo);
        
        let detailsHTML = `
            <p><strong>Path:</strong> ${modelInfo.path}</p>
            <p><strong>Base Model:</strong> ${modelInfo.base_model || 'Unknown'}</p>
            <p><strong>Format:</strong> ${modelInfo.format}</p>
        `;
        
        if (modelInfo.r !== 'unknown') {
            detailsHTML += `<p><strong>LoRA Rank (r):</strong> ${modelInfo.r}</p>`;
        }
        if (modelInfo.alpha !== 'unknown') {
            detailsHTML += `<p><strong>LoRA Alpha:</strong> ${modelInfo.alpha}</p>`;
        }
        
        detailsHTML += `<p><strong>Created:</strong> ${modelInfo.created}</p>`;
        
        detailsDiv.innerHTML = detailsHTML;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
});

// LoRA„Ç¢„ÉÄ„Éó„Çø„ÉºÈÅ©Áî®„Éï„Ç©„Éº„É†„ÅÆÂá¶ÁêÜ
document.getElementById('baseModelSelect').addEventListener('change', function() {
    const customDiv = document.getElementById('customModelUrlDiv');
    if (this.value === 'custom') {
        customDiv.style.display = 'block';
    } else {
        customDiv.style.display = 'none';
    }
});

document.getElementById('loraApplyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const baseModelSelect = document.getElementById('baseModelSelect').value;
    const outputModelName = document.getElementById('outputModelName').value;
    const loraAdapterSelect = document.getElementById('loraAdapterSelect').value;
    const resultDiv = document.getElementById('loraApplyResult');
    
    if (!loraAdapterSelect) {
        alert('Please select a fine-tuned LoRA model');
        return;
    }
    
    // „Éá„Éï„Ç©„É´„Éà„ÅÆ„É¢„Éá„É´URL„Å®„Éï„Ç°„Ç§„É´Âêç
    let baseModelUrl = "https://huggingface.co/bartowski/DeepSeek-R1-Distill-Qwen-32B-GGUF/resolve/main/DeepSeek-R1-Distill-Qwen-32B-Q4_K_M.gguf";
    let baseModelName = "DeepSeek-R1-Distill-Qwen-32B-Q4_K_M.gguf";
    
    // „Ç´„Çπ„Çø„É†„É¢„Éá„É´„ÅÆÂ†¥Âêà
    if (baseModelSelect === 'custom') {
        const customUrl = document.getElementById('customModelUrl').value;
        const customName = document.getElementById('customModelName').value;
        
        if (!customUrl || !customName) {
            alert('Please provide both custom model URL and file name');
            return;
        }
        
        baseModelUrl = customUrl;
        baseModelName = customName;
    }
    
    // API„É™„ÇØ„Ç®„Çπ„Éà„ÅÆ„Éá„Éº„Çø
    const requestData = {
        base_model_url: baseModelUrl,
        base_model_name: baseModelName,
        output_model_name: outputModelName
    };
    
    // LoRA„Ç¢„ÉÄ„Éó„Çø„Éº„Éë„Çπ„ÇíË®≠ÂÆöÔºàlatest„ÅÆÂ†¥Âêà„ÅØÁ©∫„Å´„Åó„Å¶Ëá™ÂãïÊ§úÂá∫Ôºâ
    if (loraAdapterSelect && loraAdapterSelect !== 'latest') {
        requestData.lora_adapter_path = loraAdapterSelect;
    }
    
    resultDiv.innerHTML = '<p style="color: #667eea;">üîÑ Starting LoRA adapter conversion...</p>';
    
    try {
        const response = await fetch('/api/apply-lora-to-ollama', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px;">
                    <h3>‚úÖ Conversion Started</h3>
                    <p><strong>Task ID:</strong> ${result.task_id}</p>
                    <p>${result.message}</p>
                </div>
            `;
            
            // „Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            checkLoraConversionStatus(result.task_id);
        } else {
            resultDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                    <h3>‚ùå Conversion Failed</h3>
                    <p>${result.detail || result.message || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('LoRA conversion error:', error);
        resultDiv.innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                <h3>‚ùå Error</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
});

// LoRAÂ§âÊèõ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
async function checkLoraConversionStatus(taskId) {
    const resultDiv = document.getElementById('loraApplyResult');
    
    try {
        const response = await fetch(`/api/training-status/${taskId}`);
        const status = await response.json();
        
        if (status.status === 'completed') {
            resultDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px;">
                    <h3>‚úÖ Conversion Completed!</h3>
                    <p>${status.message}</p>
                    ${status.model_name ? `
                    <p><strong>Model Name:</strong> ${status.model_name}</p>
                    <p>You can now use the model with:</p>
                    <pre style="background: #f1f1f1; padding: 10px; border-radius: 3px;">ollama run ${status.model_name} "Your question here"</pre>
                    ` : ''}
                </div>
            `;
        } else if (status.status === 'error') {
            resultDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                    <h3>‚ùå Conversion Failed</h3>
                    <p>${status.message}</p>
                </div>
            `;
        } else {
            // „Åæ„Å†ÂÆüË°å‰∏≠
            resultDiv.innerHTML = `
                <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px;">
                    <h3>‚è≥ Converting...</h3>
                    <p>${status.message}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${status.progress || 0}%"></div>
                    </div>
                </div>
            `;
            
            // 2ÁßíÂæå„Å´ÂÜç„ÉÅ„Çß„ÉÉ„ÇØ
            setTimeout(() => checkLoraConversionStatus(taskId), 2000);
        }
    } catch (error) {
        console.error('Status check error:', error);
        resultDiv.innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                <h3>‚ùå Status Check Error</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±„Å®LoRA„É¢„Éá„É´„ÇíÂèñÂæó
document.addEventListener('DOMContentLoaded', function() {
    loadSystemInfo();
    loadFinetunedLoRAModels();
});
{% endblock %} 