{% extends "base.html" %}

{% block title %}AI Fine-tuning, Text Generation & Continual Learning System{% endblock %}

{% block extra_styles %}
/* メインタブ */
.main-tabs {
    display: flex;
    border-bottom: 3px solid #2c3e50;
    margin-bottom: 30px;
    background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
    padding: 0;
    border-radius: 8px 8px 0 0;
}
.main-tab {
    flex: 1;
    padding: 15px 25px;
    cursor: pointer;
    background: transparent;
    border: none;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    text-align: center;
    position: relative;
}
.main-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}
.main-tab.active {
    background: white;
    color: #2c3e50;
    border-radius: 8px 8px 0 0;
}
.main-tab.active::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    right: 0;
    height: 3px;
    background: #3498db;
}
.main-tab-icon {
    margin-right: 8px;
    font-size: 20px;
}
.main-section {
    display: none;
    animation: fadeIn 0.3s;
}
.main-section.active {
    display: block;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* MoE埋め込みUI用のスタイル */
#embedded-moe-ui {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { 
        opacity: 0; 
        max-height: 0;
        transform: translateY(-20px);
    }
    to { 
        opacity: 1; 
        max-height: 700px;
        transform: translateY(0);
    }
}

#moe-ui-iframe {
    transition: opacity 0.3s;
    opacity: 1;
}

/* セクションスタイル */
.text-generation {
    background: #f0f8f0;
    border-left: 4px solid #4CAF50;
}
.fine-tuning {
    background: #fff8f0;
    border-left: 4px solid #FF9800;
}
.continual-learning {
    background: #f0f5ff;
    border-left: 4px solid #3498db;
}

/* サブタブ（継続学習用） */
.sub-tabs {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
    background: #f5f5f5;
    border-radius: 4px;
}
.sub-tab {
    padding: 10px 20px;
    cursor: pointer;
    background-color: transparent;
    border: none;
    margin: 4px;
    transition: all 0.3s;
    border-radius: 4px;
    font-weight: 500;
}
.sub-tab:hover {
    background: rgba(255, 255, 255, 0.5);
}
.sub-tab.active {
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #ddd;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}
.progress-fill {
    height: 100%;
    background-color: #27ae60;
    transition: width 0.3s ease;
    text-align: center;
    color: white;
    line-height: 20px;
    font-size: 12px;
}
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
}
.status-running {
    background-color: #f39c12;
    color: white;
}
.status-completed {
    background-color: #27ae60;
    color: white;
}
.status-failed {
    background-color: #e74c3c;
    color: white;
}
.task-item {
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
    background-color: #f9f9f9;
}
{% endblock %}

{% block main_title %}
            <h1>
                <img src="/static/logo_teikoku.png" alt="Logo" class="title-logo">
                🖥️ AI統合学習システム
            </h1>
            <p>テキスト生成・継続学習・ファインチューニングの統合プラットフォーム</p>
{% endblock %}

{% block content %}
<div class="container">
    <div class="content">
        <!-- メインタブ -->
        <div class="main-tabs">
            <div class="main-tab active" onclick="switchMainTab('generation')">
                <span class="main-tab-icon">✨</span>テキスト生成
            </div>
            <div class="main-tab" onclick="switchMainTab('continual')">
                <span class="main-tab-icon">🔄</span>継続学習
            </div>
            <div class="main-tab" onclick="switchMainTab('moe-rag')">
                <span class="main-tab-icon">🤖</span>MoE-RAG
            </div>
            <div class="main-tab" onclick="switchMainTab('tools')">
                <span class="main-tab-icon">🛠️</span>その他ツール
            </div>
        </div>
        
        <!-- テキスト生成セクション -->
        <div id="generation-section" class="main-section active">
            <div class="section text-generation">
            <h2>✨ Text Generation</h2>
            <form id="generateForm">
                <div class="form-group">
                    <label for="modelSelect">Model Selection:</label>
                    <select id="modelSelect" name="modelSelect" required>
                        <option value="">Select a model...</option>
                    </select>
                    <button type="button" class="btn refresh-btn" onclick="loadAvailableModels()">🔄 Refresh Models</button>
                </div>
                
                <div class="form-group">
                    <label for="prompt">Prompt:</label>
                    <textarea id="prompt" name="prompt" placeholder="Enter your question or instruction..." required></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="max_length">Max Length:</label>
                        <input type="number" id="max_length" name="max_length" value="2048" min="100" max="4096">
                    </div>
                    <div class="form-group">
                        <label for="temperature">Temperature:</label>
                        <input type="number" id="temperature" name="temperature" value="0.7" min="0.1" max="2.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="top_p">Top-p:</label>
                        <input type="number" id="top_p" name="top_p" value="0.9" min="0.1" max="1.0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="useStreaming" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="useStreaming" name="useStreaming" style="margin: 0;">
                            <span>Enable Streaming (Real-time text generation)</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="generateBtn">🚀 Generate Text</button>
            </form>
            
            <div class="loading" id="generateLoading">
                Generating text... ⏳
            </div>
            
            <div id="generateResult"></div>
            </div>
        </div>
        
        <!-- 継続学習セクション -->
        <div id="continual-section" class="main-section">
            <div class="section continual-learning">
            <h2>🔄 Continual Learning</h2>
            
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="switchContinualTab('training')">📝 新規学習</div>
                    <div class="sub-tab" onclick="switchContinualTab('tasks')">📋 タスク一覧</div>
                    <div class="sub-tab" onclick="switchContinualTab('history')">📊 学習履歴</div>
                </div>
            
            <div id="continual-training" class="tab-content active">
                <form id="continualLearningForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="baseModel">ベースモデル:</label>
                            <select id="baseModel" required>
                                <option value="">モデルを選択してください</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskName">タスク名:</label>
                            <input type="text" id="taskName" required placeholder="例: specialized_bridges">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataset">学習データセット (JSONL形式):</label>
                        <input type="file" id="dataset" accept=".jsonl" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="ewcLambda">EWC重要度 (λ):</label>
                            <input type="number" id="ewcLambda" value="5000" min="0" step="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="epochs">エポック数:</label>
                            <input type="number" id="epochs" value="3" min="1" max="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="learningRate">学習率:</label>
                            <input type="number" id="learningRate" value="0.00002" min="0" step="0.000001">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="usePreviousTasks" checked style="margin: 0;">
                            <span>以前のタスクのFisher行列を使用（破滅的忘却の防止）</span>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn" id="startContinualBtn">🚀 継続学習を開始</button>
                    <button type="button" class="btn refresh-btn" onclick="refreshContinualModels()">🔄 モデル更新</button>
                </form>
                
                <div id="currentTaskStatus" style="margin-top: 20px;">
                    <!-- 現在のタスク状態がここに表示されます -->
                </div>
            </div>
            
            <div id="continual-tasks" class="tab-content">
                <div id="taskList">
                    <p>読み込み中...</p>
                </div>
            </div>
            
            <div id="continual-history" class="tab-content">
                <div id="taskHistory">
                    <p>履歴を読み込み中...</p>
                </div>
            </div>
            </div>
        </div>
        
        <!-- MoE-RAGセクション -->
        <div id="moe-rag-section" class="main-section">
            <div class="section" style="background: #f5f0ff; border-left: 4px solid #9b59b6;">
                <h2>🤖 MoE-RAG ハイブリッド検索システム</h2>
                <p>土木工学専門のMixture of ExpertsとRAGを統合した高精度検索システム</p>
                
                <!-- UIコントロールボタン -->
                <div style="margin: 20px 0;">
                    <button onclick="toggleMoEUI()" class="btn btn-primary" id="moe-ui-toggle-btn" style="background: #9b59b6; border-color: #8e44ad;">
                        <i class="fas fa-expand"></i> MoE-RAG Web UIを展開
                    </button>
                    <button onclick="openMoETraining()" class="btn btn-outline-primary" style="color: #9b59b6; border-color: #9b59b6;">
                        <i class="fas fa-graduation-cap"></i> トレーニング管理（埋め込み）
                    </button>
                    <button onclick="window.open('/static/moe_training.html', '_blank')" class="btn btn-primary" style="background: #27ae60; border-color: #229954;">
                        <i class="fas fa-external-link-alt"></i> MoEトレーニング管理画面を新規タブで開く
                    </button>
                </div>
                
                <!-- 埋め込みMoE-RAG UI (初期は非表示) -->
                <div id="embedded-moe-ui" style="display: none; margin: 20px 0;">
                    <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 0; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="background: #9b59b6; color: white; padding: 10px; border-radius: 6px 6px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0;" id="moe-ui-title">🌐 MoE-RAG検索インターフェース</h3>
                                <div>
                                    <button onclick="switchMoEView('search')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-search"></i> 検索
                                    </button>
                                    <button onclick="switchMoEView('training')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; margin-right: 10px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-graduation-cap"></i> トレーニング
                                    </button>
                                    <button onclick="toggleMoEUI()" style="background: none; border: none; color: white; cursor: pointer; font-size: 20px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <iframe id="moe-ui-iframe" 
                                src="/static/moe_rag_ui.html" 
                                style="width: 100%; height: 600px; border: none; border-radius: 0 0 6px 6px;">
                        </iframe>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- 機能説明 -->
                    <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 20px; background: white;">
                        <h3>🚀 主要機能</h3>
                        <p>高度な検索と分析機能</p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>8つの専門エキスパート</li>
                            <li>ハイブリッド検索</li>
                            <li>信頼度スコア表示</li>
                            <li>リアルタイム回答生成</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                            <small><i class="fas fa-info-circle"></i> 上部の「Web UIを展開」ボタンでインターフェースを表示</small>
                        </div>
                    </div>
                    
                    <!-- エキスパート情報 -->
                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 20px; background: white;">
                        <h3>📊 専門エキスパート</h3>
                        <div id="expert-list" style="text-align: left; margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div>• 構造設計</div>
                                <div>• 道路設計</div>
                                <div>• 地盤工学</div>
                                <div>• 水理・排水</div>
                                <div>• 材料工学</div>
                                <div>• 施工管理</div>
                                <div>• 法規・基準</div>
                                <div>• 環境・維持管理</div>
                            </div>
                        </div>
                        <button type="button" onclick="loadMoEStatus()" class="btn btn-secondary" style="margin-top: 15px;">
                            <i class="fas fa-sync"></i> ステータス確認
                        </button>
                    </div>
                </div>
                
                <!-- クイック検索 -->
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px;">
                    <h3>🔍 クイック検索</h3>
                    <form onsubmit="analyzeMoEQuery(event); return false;">
                        <div class="form-group">
                            <input type="text" id="moe-query" class="form-control" 
                                   placeholder="例: 設計速度80km/hの道路における最小曲線半径は？"
                                   style="padding: 12px; font-size: 16px;">
                        </div>
                        <button type="submit" class="btn btn-primary" style="background: #9b59b6; border-color: #8e44ad;">
                            <i class="fas fa-search"></i> クエリ分析
                        </button>
                    </form>
                    <div id="moe-analysis-result" style="margin-top: 20px;"></div>
                </div>
                
                <!-- システムステータス -->
                <div id="moe-status" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                </div>
            </div>
        </div>
        
        <!-- その他ツールセクション -->
        <div id="tools-section" class="main-section">
            <div class="section fine-tuning">
                <h2>🎯 その他のAIツール</h2>
                <p>追加のAIツールとインターフェースにアクセス:</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="border: 2px solid #FF9800; border-radius: 8px; padding: 20px; text-align: center; background: white;">
                        <h3>📚 ファインチューニング</h3>
                        <p>モデルのカスタマイズと最適化</p>
                        <a href="/finetune" class="btn" style="width: 100%; margin-top: 10px;">インターフェースを開く</a>
                    </div>
                    <div style="border: 2px solid #4CAF50; border-radius: 8px; padding: 20px; text-align: center; background: white;">
                        <h3>🏗️ RAGシステム</h3>
                        <p>文書検索と知識ベース構築</p>
                        <a href="/rag" class="btn" style="width: 100%; margin-top: 10px;">インターフェースを開く</a>
                    </div>
                    <div style="border: 2px solid #9C27B0; border-radius: 8px; padding: 20px; text-align: center; background: white;">
                        <h3>📊 モデル管理</h3>
                        <p>学習済みモデルの管理と評価</p>
                        <a href="/models" class="btn" style="width: 100%; margin-top: 10px;">管理画面を開く</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
let selectedModel = null;
let selectedModelType = null;
let currentTaskId = null;

// ページ読み込み時にモデル一覧を取得
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableModels();
    refreshContinualModels();
    loadContinualTasks();
    
    // 継続学習フォームのサブミット処理
    document.getElementById('continualLearningForm').addEventListener('submit', startContinualLearning);
    
    // 定期的なタスク更新
    setInterval(loadContinualTasks, 5000);
});

// 利用可能なモデル一覧を取得
async function loadAvailableModels() {
    const modelSelect = document.getElementById('modelSelect');
    modelSelect.innerHTML = '<option value="">Loading models...</option>';
    
    try {
        const response = await fetch('/api/available-models');
        const data = await response.json();
        
        if (data.error) {
            modelSelect.innerHTML = '<option value="">Error loading models</option>';
            return;
        }
        
        let options = '<option value="">Select a model...</option>';
        
        // ファインチューニング済みモデル
        if (data.finetuned_models && data.finetuned_models.length > 0) {
            options += '<optgroup label="Fine-tuned Models">';
            data.finetuned_models.forEach(model => {
                options += `<option value="finetuned:${model.name}">${model.name} (${model.base_model || 'Unknown'})</option>`;
            });
            options += '</optgroup>';
        }
        
        // Ollamaモデル
        if (data.ollama_models && data.ollama_models.length > 0) {
            options += '<optgroup label="Ollama Models">';
            data.ollama_models.forEach(model => {
                options += `<option value="ollama:${model.name}">${model.name} (${model.size || 'Unknown'})</option>`;
            });
            options += '</optgroup>';
        }
        
        modelSelect.innerHTML = options;
        
    } catch (error) {
        console.error('Error loading models:', error);
        modelSelect.innerHTML = '<option value="">Error loading models</option>';
    }
}

// モデル選択
function selectModel(modelName, modelType) {
    selectedModel = modelName;
    selectedModelType = modelType;
    
    // 選択されたモデルをフォームに設定
    document.getElementById('modelSelect').value = `${modelType}:${modelName}`;
}

// テキスト生成（ストリーミング対応）
document.getElementById('generateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const modelSelect = document.getElementById('modelSelect');
    const prompt = document.getElementById('prompt').value;
    const maxLength = parseInt(document.getElementById('max_length').value);
    const temperature = parseFloat(document.getElementById('temperature').value);
    const topP = parseFloat(document.getElementById('top_p').value);
    const useStreaming = document.getElementById('useStreaming').checked;
    
    if (!modelSelect.value) {
        showAlert('generateResult', 'Please select a model', 'warning');
        return;
    }
    
    if (!prompt.trim()) {
        showAlert('generateResult', 'Please enter a prompt', 'warning');
        return;
    }
    
    const [modelType, modelName] = modelSelect.value.split(':');
    
    showAlert('generateResult', 'Generating text...', 'info');
    document.getElementById('generateLoading').style.display = 'block';
    document.getElementById('generateBtn').disabled = true;
    
    try {
        if (useStreaming) {
            // ストリーミング生成
            await generateTextStream(modelType, modelName, prompt, maxLength, temperature, topP);
        } else {
            // 通常の生成
            const response = await fetch('/api/generate-with-model-selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_type: modelType,
                    model_name: modelName,
                    prompt: prompt,
                    max_length: maxLength,
                    temperature: temperature,
                    top_p: topP
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                displayGenerationResult(result);
            } else {
                showAlert('generateResult', `Error: ${result.detail}`, 'danger');
            }
        }
    } catch (error) {
        console.error('Generation error:', error);
        showAlert('generateResult', 'Text generation failed', 'danger');
    } finally {
        document.getElementById('generateLoading').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
    }
});

// ストリーミング生成
async function generateTextStream(modelType, modelName, prompt, maxLength, temperature, topP) {
    const resultDiv = document.getElementById('generateResult');
    
    // ストリーミング結果表示エリアを初期化
    let html = '<div class="result">';
    html += '<h3>Generated Text (Streaming):</h3>';
    html += `<p><strong>Prompt:</strong> ${prompt}</p>`;
    html += `<p><strong>Generated:</strong></p>`;
    html += `<div id="streamingOutput" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 10px 0; min-height: 100px; font-family: monospace; white-space: pre-wrap;">`;
    html += '<span style="color: #666;">Generating...</span>';
    html += '</div>';
    html += '</div>';
    resultDiv.innerHTML = html;
    
    const streamingOutput = document.getElementById('streamingOutput');
    let generatedText = '';
    
    try {
        const response = await fetch('/api/generate-stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_type: modelType,
                model_name: modelName,
                prompt: prompt,
                max_length: maxLength,
                temperature: temperature,
                top_p: topP
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.error) {
                            streamingOutput.innerHTML = `<span style="color: #d32f2f;">Error: ${data.error}</span>`;
                            return;
                        }
                        
                        if (data.text !== undefined) {
                            generatedText += data.text;
                            streamingOutput.textContent = generatedText;
                            
                            // 自動スクロール
                            streamingOutput.scrollTop = streamingOutput.scrollHeight;
                        }
                        
                        if (data.done) {
                            streamingOutput.innerHTML += '<br><span style="color: #4caf50;">✓ Generation completed</span>';
                            return;
                        }
                    } catch (e) {
                        console.error('JSON parse error:', e);
                    }
                }
            }
        }
    } catch (error) {
        console.error('Streaming error:', error);
        streamingOutput.innerHTML = `<span style="color: #d32f2f;">Error: ${error.message}</span>`;
    }
}

// 結果表示
function displayGenerationResult(result) {
    const resultDiv = document.getElementById('generateResult');
    
    let html = '<div class="result">';
    html += '<h3>Generated Text:</h3>';
    html += `<p><strong>Prompt:</strong> ${result.prompt}</p>`;
    html += `<p><strong>Generated:</strong></p>`;
    html += `<div style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 10px 0;">`;
    html += `<pre style="white-space: pre-wrap; margin: 0;">${result.generated_text}</pre>`;
    html += '</div>';
    
    if (result.model_path) {
        html += `<p><strong>Model:</strong> ${result.model_path}</p>`;
    }
    
    if (result.fallback) {
        html += `<p><strong>Note:</strong> Used ${result.fallback} fallback</p>`;
    }
    
    html += '</div>';
    resultDiv.innerHTML = html;
}

// アラート表示
function showAlert(elementId, message, type) {
    const element = document.getElementById(elementId);
    const alertClass = type === 'danger' ? 'error' : type === 'warning' ? 'warning' : 'info';
    element.innerHTML = `<div class="${alertClass}">${message}</div>`;
}

// メインタブ切り替え
function switchMainTab(tabName) {
    // タブの状態を更新
    const tabs = document.querySelectorAll('.main-tab');
    const sections = document.querySelectorAll('.main-section');
    
    tabs.forEach(tab => tab.classList.remove('active'));
    sections.forEach(section => section.classList.remove('active'));
    
    // アクティブなタブを設定
    event.target.classList.add('active');
    document.getElementById(tabName + '-section').classList.add('active');
    
    // 継続学習タブが選択された場合、タスク一覧を更新
    if (tabName === 'continual') {
        loadContinualTasks();
        refreshContinualModels();
    }
    
    // MoE-RAGタブが選択された場合、ステータスを自動読み込み
    if (tabName === 'moe-rag') {
        loadMoEStatus();
    }
}

// 継続学習関連の関数

// サブタブ切り替え（継続学習用）
function switchContinualTab(tabName) {
    const tabs = document.querySelectorAll('.continual-learning .sub-tab');
    const contents = document.querySelectorAll('.continual-learning .tab-content');
    
    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById('continual-' + tabName).classList.add('active');
    
    if (tabName === 'history') {
        loadContinualHistory();
    }
}

// 継続学習用モデル一覧の更新（統合システムと同じAPIを使用）
async function refreshContinualModels() {
    try {
        const response = await fetch('/api/available-models');
        const data = await response.json();
        
        const select = document.getElementById('baseModel');
        select.innerHTML = '<option value="">モデルを選択してください</option>';
        
        // ファインチューニング済みモデル
        if (data.finetuned_models && data.finetuned_models.length > 0) {
            const optgroup1 = document.createElement('optgroup');
            optgroup1.label = 'ファインチューニング済みモデル';
            
            data.finetuned_models.forEach(model => {
                const option = document.createElement('option');
                // 継続学習ではパスを使用
                option.value = model.path || `outputs/${model.name}`;
                option.textContent = `${model.name} (${model.base_model || 'unknown'})`;
                optgroup1.appendChild(option);
            });
            
            select.appendChild(optgroup1);
        }
        
        // 推奨ベースモデル（継続学習に適したモデルのみ）
        const recommendedBaseModels = [
            "rinna/japanese-gpt2-small",
            "stabilityai/japanese-stablelm-3b-4e1t-instruct",
            "elyza/ELYZA-japanese-Llama-2-7b-instruct"
        ];
        
        if (data.ollama_models && data.ollama_models.length > 0) {
            const optgroup2 = document.createElement('optgroup');
            optgroup2.label = 'ベースモデル';
            
            data.ollama_models.forEach(model => {
                if (recommendedBaseModels.includes(model.name)) {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.size || 'unknown'})`;
                    optgroup2.appendChild(option);
                }
            });
            
            if (optgroup2.children.length > 0) {
                select.appendChild(optgroup2);
            }
        }
        
        console.log('継続学習用モデル一覧を更新しました');
        
    } catch (error) {
        console.error('Error loading continual models:', error);
    }
}

// 継続学習の開始
async function startContinualLearning(event) {
    event.preventDefault();
    
    const formData = new FormData();
    const config = {
        base_model: document.getElementById('baseModel').value,
        task_name: document.getElementById('taskName').value,
        use_previous_tasks: document.getElementById('usePreviousTasks').checked,
        ewc_lambda: parseFloat(document.getElementById('ewcLambda').value),
        epochs: parseInt(document.getElementById('epochs').value),
        learning_rate: parseFloat(document.getElementById('learningRate').value),
        use_memory_efficient: true
    };
    
    formData.append('config', JSON.stringify(config));
    formData.append('dataset', document.getElementById('dataset').files[0]);
    
    const startButton = document.getElementById('startContinualBtn');
    startButton.disabled = true;
    startButton.innerHTML = '開始中... ⏳';
    
    try {
        const response = await fetch('/api/continual-learning/start', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'エラーが発生しました');
        }
        
        const result = await response.json();
        currentTaskId = result.task_id;
        
        showAlert('currentTaskStatus', '✅ ' + result.message, 'success');
        
        // フォームをリセット
        document.getElementById('continualLearningForm').reset();
        
        // タスク一覧を更新
        loadContinualTasks();
        
    } catch (error) {
        showAlert('currentTaskStatus', 'エラー: ' + error.message, 'danger');
    } finally {
        startButton.disabled = false;
        startButton.innerHTML = '🚀 継続学習を開始';
    }
}

// タスク一覧の読み込み
async function loadContinualTasks() {
    try {
        const response = await fetch('/api/continual-learning/tasks');
        const tasks = await response.json();
        
        const taskList = document.getElementById('taskList');
        
        if (tasks.length === 0) {
            taskList.innerHTML = '<p>実行中のタスクはありません</p>';
            document.getElementById('currentTaskStatus').innerHTML = '<p>実行中のタスクはありません</p>';
            return;
        }
        
        let html = '';
        let hasRunningTask = false;
        
        tasks.forEach(task => {
            let statusBadge = '';
            if (task.status === 'running') {
                statusBadge = '<span class="status-badge status-running">実行中</span>';
                hasRunningTask = true;
                updateCurrentTaskStatus(task);
            } else if (task.status === 'completed') {
                statusBadge = '<span class="status-badge status-completed">完了</span>';
            } else if (task.status === 'failed') {
                statusBadge = '<span class="status-badge status-failed">失敗</span>';
            }
            
            html += `
                <div class="task-item">
                    <h4>${task.task_name} ${statusBadge}</h4>
                    <p>タスクID: ${task.task_id}</p>
                    <p>開始時刻: ${new Date(task.started_at).toLocaleString('ja-JP')}</p>
                    ${task.progress ? '<div class="progress-bar"><div class="progress-fill" style="width: ' + task.progress + '%">' + task.progress + '%</div></div>' : ''}
                    ${task.message ? `<p>メッセージ: ${task.message}</p>` : ''}
                </div>
            `;
        });
        
        taskList.innerHTML = html;
        
        if (!hasRunningTask) {
            document.getElementById('currentTaskStatus').innerHTML = '<p>実行中のタスクはありません</p>';
        }
        
    } catch (error) {
        console.error('Error loading tasks:', error);
    }
}

// 現在のタスク状態を更新
function updateCurrentTaskStatus(task) {
    const statusDiv = document.getElementById('currentTaskStatus');
    const progress = task.progress || 0;
    let html = '<div class="task-item">';
    html += '<h4>' + task.task_name + ' <span class="status-badge status-running">実行中</span></h4>';
    html += '<p>エポック: ' + (task.current_epoch || 0) + ' / ' + (task.total_epochs || 0) + '</p>';
    html += '<div class="progress-bar">';
    html += '<div class="progress-fill" style="width: ' + progress + '%">';
    html += progress + '%';
    html += '</div></div>';
    if (task.message) {
        html += '<p>メッセージ: ' + task.message + '</p>';
    }
    html += '</div>';
    statusDiv.innerHTML = html;
}

// 学習履歴の読み込み
async function loadContinualHistory() {
    try {
        const response = await fetch('/api/continual-learning/history');
        const history = await response.json();
        
        const historyDiv = document.getElementById('taskHistory');
        
        if (history.length === 0) {
            historyDiv.innerHTML = '<p>学習履歴がありません</p>';
            return;
        }
        
        let html = '<div style="max-height: 400px; overflow-y: auto;">';
        
        history.forEach(item => {
            html += `
                <div class="task-item">
                    <h4>${item.task_name}</h4>
                    <p>モデル: ${item.base_model}</p>
                    <p>完了日時: ${new Date(item.completed_at).toLocaleString('ja-JP')}</p>
                    <p>エポック数: ${item.epochs}</p>
                    <p>最終損失: ${item.final_loss ? item.final_loss.toFixed(4) : 'N/A'}</p>
                    ${item.output_path ? `<p>出力: ${item.output_path}</p>` : ''}
                </div>
            `;
        });
        
        html += '</div>';
        historyDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading history:', error);
        document.getElementById('taskHistory').innerHTML = '<p>履歴の読み込みに失敗しました</p>';
    }
}

// MoE-RAG関連の関数
async function loadMoEStatus() {
    console.log('Loading MoE-RAG status...');
    const statusDiv = document.getElementById('moe-status');
    
    try {
        // ステータス取得
        const statusResponse = await fetch('/api/moe-rag/status');
        const statusData = await statusResponse.json();
        
        // エキスパート情報取得
        let expertsData = null;
        if (statusData.available && statusData.initialized) {
            try {
                const expertsResponse = await fetch('/api/moe-rag/experts');
                expertsData = await expertsResponse.json();
            } catch (e) {
                console.error('Error loading experts:', e);
            }
        }
        
        statusDiv.style.display = 'block';
        
        if (statusData.available && statusData.initialized) {
            let html = `
                <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; border: 1px solid #4caf50;">
                    <div style="color: green; font-weight: bold; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i> MoE-RAGシステム: 稼働中
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5 style="margin-top: 10px;">システムコンポーネント</h5>
                            <div style="font-size: 14px;">
                                <div>エキスパートルーター: ${statusData.components.expert_router ? '✅ 有効' : '❌ 無効'}</div>
                                <div>レスポンス融合: ${statusData.components.response_fusion ? '✅ 有効' : '❌ 無効'}</div>
                                <div>最終更新: ${new Date(statusData.timestamp).toLocaleTimeString('ja-JP')}</div>
                            </div>
                        </div>
            `;
            
            if (expertsData && expertsData.experts) {
                html += `
                        <div>
                            <h5 style="margin-top: 10px;">利用可能エキスパート (${expertsData.total})</h5>
                            <div style="font-size: 12px; max-height: 150px; overflow-y: auto;">
                `;
                
                expertsData.experts.forEach(expert => {
                    html += `
                        <div style="margin: 2px 0; padding: 3px 8px; background: #f0f0f0; border-radius: 4px; 
                                    border-left: 3px solid ${expert.color || '#999'};">
                            ${expert.icon || '•'} <strong>${expert.name}</strong>: ${expert.description}
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            statusDiv.innerHTML = html;
        } else {
            statusDiv.innerHTML = `
                <div style="padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ff9800;">
                    <div style="color: orange;">
                        <i class="fas fa-exclamation-triangle"></i> MoE-RAGシステム: 初期化中...
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading MoE status:', error);
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
            <div style="padding: 15px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336;">
                <div style="color: red;">
                    <i class="fas fa-times-circle"></i> MoE-RAGシステム: エラー
                    <div style="font-size: 12px; margin-top: 5px;">${error.message}</div>
                </div>
            </div>
        `;
    }
}

// MoE UI展開/折りたたみ機能
function toggleMoEUI() {
    const embeddedUI = document.getElementById('embedded-moe-ui');
    const toggleBtn = document.getElementById('moe-ui-toggle-btn');
    
    if (embeddedUI.style.display === 'none' || embeddedUI.style.display === '') {
        // 展開
        embeddedUI.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-compress"></i> MoE-RAG Web UIを折りたたむ';
        
        // iframe再読み込み（必要に応じて）
        const iframe = document.getElementById('moe-ui-iframe');
        if (!iframe.src) {
            iframe.src = '/static/moe_rag_ui.html';
        }
        
        // スムーズスクロール
        embeddedUI.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // 折りたたみ
        embeddedUI.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-expand"></i> MoE-RAG Web UIを展開';
    }
}

// トレーニング管理画面を開く
function openMoETraining() {
    switchMoEView('training');
}

// MoE UI内のビューを切り替え
function switchMoEView(view) {
    const embeddedUI = document.getElementById('embedded-moe-ui');
    const iframe = document.getElementById('moe-ui-iframe');
    const toggleBtn = document.getElementById('moe-ui-toggle-btn');
    const titleElement = document.getElementById('moe-ui-title');
    
    // UIを展開
    embeddedUI.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-compress"></i> MoE-RAG Web UIを折りたたむ';
    
    // ビューに応じてiframeのソースとタイトルを変更
    if (view === 'training') {
        iframe.src = '/static/moe_training.html';
        titleElement.innerHTML = '🎓 MoEトレーニング管理';
    } else {
        iframe.src = '/static/moe_rag_ui.html';
        titleElement.innerHTML = '🌐 MoE-RAG検索インターフェース';
    }
    
    // スムーズスクロール
    embeddedUI.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function analyzeMoEQuery(event) {
    event.preventDefault();
    
    const query = document.getElementById('moe-query').value;
    if (!query) {
        alert('クエリを入力してください');
        return;
    }
    
    const resultDiv = document.getElementById('moe-analysis-result');
    resultDiv.innerHTML = '<div class="loading">分析中...</div>';
    
    try {
        const response = await fetch(`/api/moe-rag/analyze?query=${encodeURIComponent(query)}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        let html = `
            <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                <h4>クエリ分析結果</h4>
                <div style="margin-top: 15px;">
                    <strong>選択されたエキスパート:</strong>
                    <div style="margin-top: 5px;">
        `;
        
        data.primary_experts.forEach(expert => {
            html += `<span style="display: inline-block; padding: 5px 10px; margin: 5px; 
                            background: #9b59b6; color: white; border-radius: 5px;">
                        ${expert}
                    </span>`;
        });
        
        html += `
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <strong>ルーティング戦略:</strong> ${data.routing_strategy}
                </div>
                <div style="margin-top: 15px;">
                    <strong>信頼度:</strong> 
                    <div style="display: inline-block; width: 200px; height: 20px; 
                                background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div style="width: ${data.confidence * 100}%; height: 100%; 
                                    background: linear-gradient(90deg, #f39c12, #27ae60);"></div>
                    </div>
                    ${(data.confidence * 100).toFixed(1)}%
                </div>
                <div style="margin-top: 15px;">
                    <strong>クエリ複雑度:</strong> ${(data.complexity.complexity_score * 100).toFixed(1)}%
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="executeQueryInEmbedded('${encodeURIComponent(query)}')" 
                       class="btn btn-primary" 
                       style="background: #9b59b6; border-color: #8e44ad;">
                        <i class="fas fa-search"></i> 詳細検索を実行
                    </button>
                </div>
            </div>
        `;
        
        resultDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Error analyzing query:', error);
        resultDiv.innerHTML = `
            <div style="color: red; padding: 15px; background: #fee; border-radius: 8px;">
                <i class="fas fa-times-circle"></i> エラー: ${error.message}
            </div>
        `;
    }
}

// 埋め込みUIでクエリを実行
function executeQueryInEmbedded(encodedQuery) {
    const embeddedUI = document.getElementById('embedded-moe-ui');
    const iframe = document.getElementById('moe-ui-iframe');
    const toggleBtn = document.getElementById('moe-ui-toggle-btn');
    
    // UIを展開
    embeddedUI.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-compress"></i> MoE-RAG Web UIを折りたたむ';
    
    // クエリ付きでUIを読み込み
    iframe.src = `/static/moe_rag_ui.html?query=${encodedQuery}`;
    
    // スムーズスクロール
    embeddedUI.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
{% endblock %} 