{% extends "base.html" %}

{% block title %}AI Fine-tuning, Text Generation & Continual Learning System{% endblock %}

{% block extra_styles %}
/* ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– */
.main-tabs {
    display: flex;
    border-bottom: 3px solid #2c3e50;
    margin-bottom: 30px;
    background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
    padding: 0;
    border-radius: 8px 8px 0 0;
}
.main-tab {
    flex: 1;
    padding: 15px 25px;
    cursor: pointer;
    background: transparent;
    border: none;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    text-align: center;
    position: relative;
}
.main-tab:hover {
    background: rgba(52, 152, 219, 0.1);
}
.main-tab.active {
    background: white;
    color: #2c3e50;
    border-radius: 8px 8px 0 0;
}
.main-tab.active::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    right: 0;
    height: 3px;
    background: #3498db;
}
.main-tab-icon {
    margin-right: 8px;
    font-size: 20px;
}
.main-section {
    display: none;
    animation: fadeIn 0.3s;
}
.main-section.active {
    display: block;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* MoEåŸ‹ã‚è¾¼ã¿UIç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#embedded-moe-ui {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { 
        opacity: 0; 
        max-height: 0;
        transform: translateY(-20px);
    }
    to { 
        opacity: 1; 
        max-height: 700px;
        transform: translateY(0);
    }
}

#moe-ui-iframe {
    transition: opacity 0.3s;
    opacity: 1;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.text-generation {
    background: #f0f8f0;
    border-left: 4px solid #4CAF50;
}
.fine-tuning {
    background: #fff8f0;
    border-left: 4px solid #FF9800;
}
.continual-learning {
    background: #f0f5ff;
    border-left: 4px solid #3498db;
}

/* ã‚µãƒ–ã‚¿ãƒ–ï¼ˆç¶™ç¶šå­¦ç¿’ç”¨ï¼‰ */
.sub-tabs {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 20px;
    background: #f5f5f5;
    border-radius: 4px;
}
.sub-tab {
    padding: 10px 20px;
    cursor: pointer;
    background-color: transparent;
    border: none;
    margin: 4px;
    transition: all 0.3s;
    border-radius: 4px;
    font-weight: 500;
}
.sub-tab:hover {
    background: rgba(255, 255, 255, 0.5);
}
.sub-tab.active {
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #ddd;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}
.progress-fill {
    height: 100%;
    background-color: #27ae60;
    transition: width 0.3s ease;
    text-align: center;
    color: white;
    line-height: 20px;
    font-size: 12px;
}
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 10px;
}
.status-running {
    background-color: #f39c12;
    color: white;
}
.status-completed {
    background-color: #27ae60;
    color: white;
}
.status-failed {
    background-color: #e74c3c;
    color: white;
}
.task-item {
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
    background-color: #f9f9f9;
}
{% endblock %}

{% block main_title %}
            <h1>
                <img src="/static/logo_teikoku.png" alt="Logo" class="title-logo">
                ğŸ–¥ï¸ AIçµ±åˆå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
            </h1>
            <p>ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆãƒ»ç¶™ç¶šå­¦ç¿’ãƒ»ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®çµ±åˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
{% endblock %}

{% block content %}
<div class="container">
    <div class="content">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– -->
        <div class="main-tabs">
            <div class="main-tab active" onclick="switchMainTab('generation')">
                <span class="main-tab-icon">âœ¨</span>ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            </div>
            <div class="main-tab" onclick="switchMainTab('continual')">
                <span class="main-tab-icon">ğŸ”„</span>ç¶™ç¶šå­¦ç¿’
            </div>
            <div class="main-tab" onclick="switchMainTab('moe-rag')">
                <span class="main-tab-icon">ğŸ¤–</span>MoE-RAG
            </div>
            <div class="main-tab" onclick="switchMainTab('tools')">
                <span class="main-tab-icon">ğŸ› ï¸</span>ãã®ä»–ãƒ„ãƒ¼ãƒ«
            </div>
        </div>
        
        <!-- ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="generation-section" class="main-section active">
            <div class="section text-generation">
            <h2>âœ¨ Text Generation</h2>
            <form id="generateForm">
                <div class="form-group">
                    <label for="modelSelect">Model Selection:</label>
                    <select id="modelSelect" name="modelSelect" required>
                        <option value="">Select a model...</option>
                    </select>
                    <button type="button" class="btn refresh-btn" onclick="loadAvailableModels()">ğŸ”„ Refresh Models</button>
                </div>
                
                <div class="form-group">
                    <label for="prompt">Prompt:</label>
                    <textarea id="prompt" name="prompt" placeholder="Enter your question or instruction..." required></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="max_length">Max Length:</label>
                        <input type="number" id="max_length" name="max_length" value="2048" min="100" max="4096">
                    </div>
                    <div class="form-group">
                        <label for="temperature">Temperature:</label>
                        <input type="number" id="temperature" name="temperature" value="0.7" min="0.1" max="2.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="top_p">Top-p:</label>
                        <input type="number" id="top_p" name="top_p" value="0.9" min="0.1" max="1.0" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="useStreaming" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="useStreaming" name="useStreaming" style="margin: 0;">
                            <span>Enable Streaming (Real-time text generation)</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="generateBtn">ğŸš€ Generate Text</button>
            </form>
            
            <div class="loading" id="generateLoading">
                Generating text... â³
            </div>
            
            <div id="generateResult"></div>
            </div>
        </div>
        
        <!-- ç¶™ç¶šå­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="continual-section" class="main-section">
            <div class="section continual-learning">
            <h2>ğŸ”„ Continual Learning</h2>
            
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="switchContinualTab('training')">ğŸ“ æ–°è¦å­¦ç¿’</div>
                    <div class="sub-tab" onclick="switchContinualTab('tasks')">ğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§</div>
                    <div class="sub-tab" onclick="switchContinualTab('history')">ğŸ“Š å­¦ç¿’å±¥æ­´</div>
                </div>
            
            <div id="continual-training" class="tab-content active">
                <form id="continualLearningForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="baseModel">ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«:</label>
                            <select id="baseModel" required>
                                <option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskName">ã‚¿ã‚¹ã‚¯å:</label>
                            <input type="text" id="taskName" required placeholder="ä¾‹: specialized_bridges">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataset">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ (JSONLå½¢å¼):</label>
                        <input type="file" id="dataset" accept=".jsonl" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="ewcLambda">EWCé‡è¦åº¦ (Î»):</label>
                            <input type="number" id="ewcLambda" value="5000" min="0" step="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="epochs">ã‚¨ãƒãƒƒã‚¯æ•°:</label>
                            <input type="number" id="epochs" value="3" min="1" max="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="learningRate">å­¦ç¿’ç‡:</label>
                            <input type="number" id="learningRate" value="0.00002" min="0" step="0.000001">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="usePreviousTasks" checked style="margin: 0;">
                            <span>ä»¥å‰ã®ã‚¿ã‚¹ã‚¯ã®Fisherè¡Œåˆ—ã‚’ä½¿ç”¨ï¼ˆç ´æ»…çš„å¿˜å´ã®é˜²æ­¢ï¼‰</span>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn" id="startContinualBtn">ğŸš€ ç¶™ç¶šå­¦ç¿’ã‚’é–‹å§‹</button>
                    <button type="button" class="btn refresh-btn" onclick="refreshContinualModels()">ğŸ”„ ãƒ¢ãƒ‡ãƒ«æ›´æ–°</button>
                </form>
                
                <div id="currentTaskStatus" style="margin-top: 20px;">
                    <!-- ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <div id="continual-tasks" class="tab-content">
                <div id="taskList">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
            
            <div id="continual-history" class="tab-content">
                <div id="taskHistory">
                    <p>å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
            </div>
        </div>
        
        <!-- MoE-RAGã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="moe-rag-section" class="main-section">
            <div class="section" style="background: #f5f0ff; border-left: 4px solid #9b59b6;">
                <h2>ğŸ¤– MoE-RAG ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h2>
                <p>åœŸæœ¨å·¥å­¦å°‚é–€ã®Mixture of Expertsã¨RAGã‚’çµ±åˆã—ãŸé«˜ç²¾åº¦æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </p>
                
                <!-- UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                <div style="margin: 20px 0;">
                    <button onclick="toggleMoEUI()" class="btn btn-primary" id="moe-ui-toggle-btn" style="background: #9b59b6; border-color: #8e44ad;">
                        <i class="fas fa-expand"></i> MoE-RAG Web UIã‚’å±•é–‹
                    </button>
                    <button onclick="openMoETraining()" class="btn btn-outline-primary" style="color: #9b59b6; border-color: #9b59b6;">
                        <i class="fas fa-graduation-cap"></i> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†ï¼ˆåŸ‹ã‚è¾¼ã¿ï¼‰
                    </button>
                    <button onclick="window.open('/static/moe_training.html', '_blank')" class="btn btn-primary" style="background: #27ae60; border-color: #229954;">
                        <i class="fas fa-external-link-alt"></i> MoEãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†ç”»é¢ã‚’æ–°è¦ã‚¿ãƒ–ã§é–‹ã
                    </button>
                </div>
                
                <!-- åŸ‹ã‚è¾¼ã¿MoE-RAG UI (åˆæœŸã¯éè¡¨ç¤º) -->
                <div id="embedded-moe-ui" style="display: none; margin: 20px 0;">
                    <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 0; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="background: #9b59b6; color: white; padding: 10px; border-radius: 6px 6px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0;" id="moe-ui-title">ğŸŒ MoE-RAGæ¤œç´¢ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</h3>
                                <div>
                                    <button onclick="switchMoEView('search')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; margin-right: 5px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-search"></i> æ¤œç´¢
                                    </button>
                                    <button onclick="switchMoEView('training')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; margin-right: 10px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-graduation-cap"></i> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°
                                    </button>
                                    <button onclick="toggleMoEUI()" style="background: none; border: none; color: white; cursor: pointer; font-size: 20px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <iframe id="moe-ui-iframe" 
                                src="/static/moe_rag_ui.html" 
                                style="width: 100%; height: 600px; border: none; border-radius: 0 0 6px 6px;">
                        </iframe>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- æ©Ÿèƒ½èª¬æ˜ -->
                    <div style="border: 2px solid #9b59b6; border-radius: 8px; padding: 20px; background: white;">
                        <h3>ğŸš€ ä¸»è¦æ©Ÿèƒ½</h3>
                        <p>é«˜åº¦ãªæ¤œç´¢ã¨åˆ†ææ©Ÿèƒ½</p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>8ã¤ã®å°‚é–€ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ</li>
                            <li>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢</li>
                            <li>ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢è¡¨ç¤º</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å›ç­”ç”Ÿæˆ</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                            <small><i class="fas fa-info-circle"></i> ä¸Šéƒ¨ã®ã€ŒWeb UIã‚’å±•é–‹ã€ãƒœã‚¿ãƒ³ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’è¡¨ç¤º</small>
                        </div>
                    </div>
                    
                    <!-- ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆæƒ…å ± -->
                    <div style="border: 2px solid #3498db; border-radius: 8px; padding: 20px; background: white;">
                        <h3>ğŸ“Š å°‚é–€ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ</h3>
                        <div id="expert-list" style="text-align: left; margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div>â€¢ æ§‹é€ è¨­è¨ˆ</div>
                                <div>â€¢ é“è·¯è¨­è¨ˆ</div>
                                <div>â€¢ åœ°ç›¤å·¥å­¦</div>
                                <div>â€¢ æ°´ç†ãƒ»æ’æ°´</div>
                                <div>â€¢ ææ–™å·¥å­¦</div>
                                <div>â€¢ æ–½å·¥ç®¡ç†</div>
                                <div>â€¢ æ³•è¦ãƒ»åŸºæº–</div>
                                <div>â€¢ ç’°å¢ƒãƒ»ç¶­æŒç®¡ç†</div>
                            </div>
                        </div>
                        <button type="button" onclick="loadMoEStatus()" class="btn btn-secondary" style="margin-top: 15px;">
                            <i class="fas fa-sync"></i> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
                        </button>
                    </div>
                </div>
                
                <!-- ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢ -->
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px;">
                    <h3>ğŸ” ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢</h3>
                    <form onsubmit="analyzeMoEQuery(event); return false;">
                        <div class="form-group">
                            <input type="text" id="moe-query" class="form-control" 
                                   placeholder="ä¾‹: è¨­è¨ˆé€Ÿåº¦80km/hã®é“è·¯ã«ãŠã‘ã‚‹æœ€å°æ›²ç·šåŠå¾„ã¯ï¼Ÿ"
                                   style="padding: 12px; font-size: 16px;">
                        </div>
                        <button type="submit" class="btn btn-primary" style="background: #9b59b6; border-color: #8e44ad;">
                            <i class="fas fa-search"></i> ã‚¯ã‚¨ãƒªåˆ†æ
                        </button>
                    </form>
                    <div id="moe-analysis-result" style="margin-top: 20px;"></div>
                </div>
                
                <!-- ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div id="moe-status" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                </div>
            </div>
        </div>
        
        <!-- ãã®ä»–ãƒ„ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="tools-section" class="main-section">
            <div class="section fine-tuning">
                <h2>ğŸ¯ ãã®ä»–ã®AIãƒ„ãƒ¼ãƒ«</h2>
                <p>è¿½åŠ ã®AIãƒ„ãƒ¼ãƒ«ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹:</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="border: 2px solid #FF9800; border-radius: 8px; padding: 20px; text-align: center; background: white;">
                        <h3>ğŸ“š ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°</h3>
                        <p>ãƒ¢ãƒ‡ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¨æœ€é©åŒ–</p>
                        <a href="/finetune" class="btn" style="width: 100%; margin-top: 10px;">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’é–‹ã</a>
                    </div>
                    <div style="border: 2px solid #4CAF50; border-radius: 8px; padding: 20px; text-align: center; background: white;">
                        <h3>ğŸ—ï¸ RAGã‚·ã‚¹ãƒ†ãƒ </h3>
                        <p>æ–‡æ›¸æ¤œç´¢ã¨çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰</p>
                        <a href="/rag" class="btn" style="width: 100%; margin-top: 10px;">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’é–‹ã</a>
                    </div>
                    <div style="border: 2px solid #9C27B0; border-radius: 8px; padding: 20px; text-align: center; background: white;">
                        <h3>ğŸ“Š ãƒ¢ãƒ‡ãƒ«ç®¡ç†</h3>
                        <p>å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã®ç®¡ç†ã¨è©•ä¾¡</p>
                        <a href="/models" class="btn" style="width: 100%; margin-top: 10px;">ç®¡ç†ç”»é¢ã‚’é–‹ã</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
let selectedModel = null;
let selectedModelType = null;
let currentTaskId = null;

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableModels();
    refreshContinualModels();
    loadContinualTasks();
    
    // ç¶™ç¶šå­¦ç¿’ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚µãƒ–ãƒŸãƒƒãƒˆå‡¦ç†
    document.getElementById('continualLearningForm').addEventListener('submit', startContinualLearning);
    
    // å®šæœŸçš„ãªã‚¿ã‚¹ã‚¯æ›´æ–°
    setInterval(loadContinualTasks, 5000);
});

// åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—
async function loadAvailableModels() {
    const modelSelect = document.getElementById('modelSelect');
    modelSelect.innerHTML = '<option value="">Loading models...</option>';
    
    try {
        const response = await fetch('/api/available-models');
        const data = await response.json();
        
        if (data.error) {
            modelSelect.innerHTML = '<option value="">Error loading models</option>';
            return;
        }
        
        let options = '<option value="">Select a model...</option>';
        
        // ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«
        if (data.finetuned_models && data.finetuned_models.length > 0) {
            options += '<optgroup label="Fine-tuned Models">';
            data.finetuned_models.forEach(model => {
                options += `<option value="finetuned:${model.name}">${model.name} (${model.base_model || 'Unknown'})</option>`;
            });
            options += '</optgroup>';
        }
        
        // Ollamaãƒ¢ãƒ‡ãƒ«
        if (data.ollama_models && data.ollama_models.length > 0) {
            options += '<optgroup label="Ollama Models">';
            data.ollama_models.forEach(model => {
                options += `<option value="ollama:${model.name}">${model.name} (${model.size || 'Unknown'})</option>`;
            });
            options += '</optgroup>';
        }
        
        modelSelect.innerHTML = options;
        
    } catch (error) {
        console.error('Error loading models:', error);
        modelSelect.innerHTML = '<option value="">Error loading models</option>';
    }
}

// ãƒ¢ãƒ‡ãƒ«é¸æŠ
function selectModel(modelName, modelType) {
    selectedModel = modelName;
    selectedModelType = modelType;
    
    // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®š
    document.getElementById('modelSelect').value = `${modelType}:${modelName}`;
}

// ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œï¼‰
document.getElementById('generateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const modelSelect = document.getElementById('modelSelect');
    const prompt = document.getElementById('prompt').value;
    const maxLength = parseInt(document.getElementById('max_length').value);
    const temperature = parseFloat(document.getElementById('temperature').value);
    const topP = parseFloat(document.getElementById('top_p').value);
    const useStreaming = document.getElementById('useStreaming').checked;
    
    if (!modelSelect.value) {
        showAlert('generateResult', 'Please select a model', 'warning');
        return;
    }
    
    if (!prompt.trim()) {
        showAlert('generateResult', 'Please enter a prompt', 'warning');
        return;
    }
    
    const [modelType, modelName] = modelSelect.value.split(':');
    
    showAlert('generateResult', 'Generating text...', 'info');
    document.getElementById('generateLoading').style.display = 'block';
    document.getElementById('generateBtn').disabled = true;
    
    try {
        if (useStreaming) {
            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”Ÿæˆ
            await generateTextStream(modelType, modelName, prompt, maxLength, temperature, topP);
        } else {
            // é€šå¸¸ã®ç”Ÿæˆ
            const response = await fetch('/api/generate-with-model-selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model_type: modelType,
                    model_name: modelName,
                    prompt: prompt,
                    max_length: maxLength,
                    temperature: temperature,
                    top_p: topP
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                displayGenerationResult(result);
            } else {
                showAlert('generateResult', `Error: ${result.detail}`, 'danger');
            }
        }
    } catch (error) {
        console.error('Generation error:', error);
        showAlert('generateResult', 'Text generation failed', 'danger');
    } finally {
        document.getElementById('generateLoading').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
    }
});

// ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”Ÿæˆ
async function generateTextStream(modelType, modelName, prompt, maxLength, temperature, topP) {
    const resultDiv = document.getElementById('generateResult');
    
    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’åˆæœŸåŒ–
    let html = '<div class="result">';
    html += '<h3>Generated Text (Streaming):</h3>';
    html += `<p><strong>Prompt:</strong> ${prompt}</p>`;
    html += `<p><strong>Generated:</strong></p>`;
    html += `<div id="streamingOutput" style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 10px 0; min-height: 100px; font-family: monospace; white-space: pre-wrap;">`;
    html += '<span style="color: #666;">Generating...</span>';
    html += '</div>';
    html += '</div>';
    resultDiv.innerHTML = html;
    
    const streamingOutput = document.getElementById('streamingOutput');
    let generatedText = '';
    
    try {
        const response = await fetch('/api/generate-stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_type: modelType,
                model_name: modelName,
                prompt: prompt,
                max_length: maxLength,
                temperature: temperature,
                top_p: topP
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const { done, value } = await reader.read();
            
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.error) {
                            streamingOutput.innerHTML = `<span style="color: #d32f2f;">Error: ${data.error}</span>`;
                            return;
                        }
                        
                        if (data.text !== undefined) {
                            generatedText += data.text;
                            streamingOutput.textContent = generatedText;
                            
                            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                            streamingOutput.scrollTop = streamingOutput.scrollHeight;
                        }
                        
                        if (data.done) {
                            streamingOutput.innerHTML += '<br><span style="color: #4caf50;">âœ“ Generation completed</span>';
                            return;
                        }
                    } catch (e) {
                        console.error('JSON parse error:', e);
                    }
                }
            }
        }
    } catch (error) {
        console.error('Streaming error:', error);
        streamingOutput.innerHTML = `<span style="color: #d32f2f;">Error: ${error.message}</span>`;
    }
}

// çµæœè¡¨ç¤º
function displayGenerationResult(result) {
    const resultDiv = document.getElementById('generateResult');
    
    let html = '<div class="result">';
    html += '<h3>Generated Text:</h3>';
    html += `<p><strong>Prompt:</strong> ${result.prompt}</p>`;
    html += `<p><strong>Generated:</strong></p>`;
    html += `<div style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 10px 0;">`;
    html += `<pre style="white-space: pre-wrap; margin: 0;">${result.generated_text}</pre>`;
    html += '</div>';
    
    if (result.model_path) {
        html += `<p><strong>Model:</strong> ${result.model_path}</p>`;
    }
    
    if (result.fallback) {
        html += `<p><strong>Note:</strong> Used ${result.fallback} fallback</p>`;
    }
    
    html += '</div>';
    resultDiv.innerHTML = html;
}

// ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
function showAlert(elementId, message, type) {
    const element = document.getElementById(elementId);
    const alertClass = type === 'danger' ? 'error' : type === 'warning' ? 'warning' : 'info';
    element.innerHTML = `<div class="${alertClass}">${message}</div>`;
}

// ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchMainTab(tabName) {
    // ã‚¿ãƒ–ã®çŠ¶æ…‹ã‚’æ›´æ–°
    const tabs = document.querySelectorAll('.main-tab');
    const sections = document.querySelectorAll('.main-section');
    
    tabs.forEach(tab => tab.classList.remove('active'));
    sections.forEach(section => section.classList.remove('active'));
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’è¨­å®š
    event.target.classList.add('active');
    document.getElementById(tabName + '-section').classList.add('active');
    
    // ç¶™ç¶šå­¦ç¿’ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
    if (tabName === 'continual') {
        loadContinualTasks();
        refreshContinualModels();
    }
    
    // MoE-RAGã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
    if (tabName === 'moe-rag') {
        loadMoEStatus();
    }
}

// ç¶™ç¶šå­¦ç¿’é–¢é€£ã®é–¢æ•°

// ã‚µãƒ–ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆç¶™ç¶šå­¦ç¿’ç”¨ï¼‰
function switchContinualTab(tabName) {
    const tabs = document.querySelectorAll('.continual-learning .sub-tab');
    const contents = document.querySelectorAll('.continual-learning .tab-content');
    
    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById('continual-' + tabName).classList.add('active');
    
    if (tabName === 'history') {
        loadContinualHistory();
    }
}

// ç¶™ç¶šå­¦ç¿’ç”¨ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã®æ›´æ–°ï¼ˆçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã¨åŒã˜APIã‚’ä½¿ç”¨ï¼‰
async function refreshContinualModels() {
    try {
        const response = await fetch('/api/available-models');
        const data = await response.json();
        
        const select = document.getElementById('baseModel');
        select.innerHTML = '<option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        // ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«
        if (data.finetuned_models && data.finetuned_models.length > 0) {
            const optgroup1 = document.createElement('optgroup');
            optgroup1.label = 'ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«';
            
            data.finetuned_models.forEach(model => {
                const option = document.createElement('option');
                // ç¶™ç¶šå­¦ç¿’ã§ã¯ãƒ‘ã‚¹ã‚’ä½¿ç”¨
                option.value = model.path || `outputs/${model.name}`;
                option.textContent = `${model.name} (${model.base_model || 'unknown'})`;
                optgroup1.appendChild(option);
            });
            
            select.appendChild(optgroup1);
        }
        
        // æ¨å¥¨ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«ï¼ˆç¶™ç¶šå­¦ç¿’ã«é©ã—ãŸãƒ¢ãƒ‡ãƒ«ã®ã¿ï¼‰
        const recommendedBaseModels = [
            "rinna/japanese-gpt2-small",
            "stabilityai/japanese-stablelm-3b-4e1t-instruct",
            "elyza/ELYZA-japanese-Llama-2-7b-instruct"
        ];
        
        if (data.ollama_models && data.ollama_models.length > 0) {
            const optgroup2 = document.createElement('optgroup');
            optgroup2.label = 'ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«';
            
            data.ollama_models.forEach(model => {
                if (recommendedBaseModels.includes(model.name)) {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.size || 'unknown'})`;
                    optgroup2.appendChild(option);
                }
            });
            
            if (optgroup2.children.length > 0) {
                select.appendChild(optgroup2);
            }
        }
        
        console.log('ç¶™ç¶šå­¦ç¿’ç”¨ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        
    } catch (error) {
        console.error('Error loading continual models:', error);
    }
}

// ç¶™ç¶šå­¦ç¿’ã®é–‹å§‹
async function startContinualLearning(event) {
    event.preventDefault();
    
    const formData = new FormData();
    const config = {
        base_model: document.getElementById('baseModel').value,
        task_name: document.getElementById('taskName').value,
        use_previous_tasks: document.getElementById('usePreviousTasks').checked,
        ewc_lambda: parseFloat(document.getElementById('ewcLambda').value),
        epochs: parseInt(document.getElementById('epochs').value),
        learning_rate: parseFloat(document.getElementById('learningRate').value),
        use_memory_efficient: true
    };
    
    formData.append('config', JSON.stringify(config));
    formData.append('dataset', document.getElementById('dataset').files[0]);
    
    const startButton = document.getElementById('startContinualBtn');
    startButton.disabled = true;
    startButton.innerHTML = 'é–‹å§‹ä¸­... â³';
    
    try {
        const response = await fetch('/api/continual-learning/start', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
        
        const result = await response.json();
        currentTaskId = result.task_id;
        
        showAlert('currentTaskStatus', 'âœ… ' + result.message, 'success');
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('continualLearningForm').reset();
        
        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
        loadContinualTasks();
        
    } catch (error) {
        showAlert('currentTaskStatus', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
    } finally {
        startButton.disabled = false;
        startButton.innerHTML = 'ğŸš€ ç¶™ç¶šå­¦ç¿’ã‚’é–‹å§‹';
    }
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®èª­ã¿è¾¼ã¿
async function loadContinualTasks() {
    try {
        const response = await fetch('/api/continual-learning/tasks');
        const tasks = await response.json();
        
        const taskList = document.getElementById('taskList');
        
        if (tasks.length === 0) {
            taskList.innerHTML = '<p>å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            document.getElementById('currentTaskStatus').innerHTML = '<p>å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        let html = '';
        let hasRunningTask = false;
        
        tasks.forEach(task => {
            let statusBadge = '';
            if (task.status === 'running') {
                statusBadge = '<span class="status-badge status-running">å®Ÿè¡Œä¸­</span>';
                hasRunningTask = true;
                updateCurrentTaskStatus(task);
            } else if (task.status === 'completed') {
                statusBadge = '<span class="status-badge status-completed">å®Œäº†</span>';
            } else if (task.status === 'failed') {
                statusBadge = '<span class="status-badge status-failed">å¤±æ•—</span>';
            }
            
            html += `
                <div class="task-item">
                    <h4>${task.task_name} ${statusBadge}</h4>
                    <p>ã‚¿ã‚¹ã‚¯ID: ${task.task_id}</p>
                    <p>é–‹å§‹æ™‚åˆ»: ${new Date(task.started_at).toLocaleString('ja-JP')}</p>
                    ${task.progress ? '<div class="progress-bar"><div class="progress-fill" style="width: ' + task.progress + '%">' + task.progress + '%</div></div>' : ''}
                    ${task.message ? `<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${task.message}</p>` : ''}
                </div>
            `;
        });
        
        taskList.innerHTML = html;
        
        if (!hasRunningTask) {
            document.getElementById('currentTaskStatus').innerHTML = '<p>å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }
        
    } catch (error) {
        console.error('Error loading tasks:', error);
    }
}

// ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ã‚’æ›´æ–°
function updateCurrentTaskStatus(task) {
    const statusDiv = document.getElementById('currentTaskStatus');
    const progress = task.progress || 0;
    let html = '<div class="task-item">';
    html += '<h4>' + task.task_name + ' <span class="status-badge status-running">å®Ÿè¡Œä¸­</span></h4>';
    html += '<p>ã‚¨ãƒãƒƒã‚¯: ' + (task.current_epoch || 0) + ' / ' + (task.total_epochs || 0) + '</p>';
    html += '<div class="progress-bar">';
    html += '<div class="progress-fill" style="width: ' + progress + '%">';
    html += progress + '%';
    html += '</div></div>';
    if (task.message) {
        html += '<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + task.message + '</p>';
    }
    html += '</div>';
    statusDiv.innerHTML = html;
}

// å­¦ç¿’å±¥æ­´ã®èª­ã¿è¾¼ã¿
async function loadContinualHistory() {
    try {
        const response = await fetch('/api/continual-learning/history');
        const history = await response.json();
        
        const historyDiv = document.getElementById('taskHistory');
        
        if (history.length === 0) {
            historyDiv.innerHTML = '<p>å­¦ç¿’å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        let html = '<div style="max-height: 400px; overflow-y: auto;">';
        
        history.forEach(item => {
            html += `
                <div class="task-item">
                    <h4>${item.task_name}</h4>
                    <p>ãƒ¢ãƒ‡ãƒ«: ${item.base_model}</p>
                    <p>å®Œäº†æ—¥æ™‚: ${new Date(item.completed_at).toLocaleString('ja-JP')}</p>
                    <p>ã‚¨ãƒãƒƒã‚¯æ•°: ${item.epochs}</p>
                    <p>æœ€çµ‚æå¤±: ${item.final_loss ? item.final_loss.toFixed(4) : 'N/A'}</p>
                    ${item.output_path ? `<p>å‡ºåŠ›: ${item.output_path}</p>` : ''}
                </div>
            `;
        });
        
        html += '</div>';
        historyDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading history:', error);
        document.getElementById('taskHistory').innerHTML = '<p>å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
    }
}

// MoE-RAGé–¢é€£ã®é–¢æ•°
async function loadMoEStatus() {
    console.log('Loading MoE-RAG status...');
    const statusDiv = document.getElementById('moe-status');
    
    try {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
        const statusResponse = await fetch('/api/moe-rag/status');
        const statusData = await statusResponse.json();
        
        // ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆæƒ…å ±å–å¾—
        let expertsData = null;
        if (statusData.available && statusData.initialized) {
            try {
                const expertsResponse = await fetch('/api/moe-rag/experts');
                expertsData = await expertsResponse.json();
            } catch (e) {
                console.error('Error loading experts:', e);
            }
        }
        
        statusDiv.style.display = 'block';
        
        if (statusData.available && statusData.initialized) {
            let html = `
                <div style="padding: 15px; background: #e8f5e9; border-radius: 8px; border: 1px solid #4caf50;">
                    <div style="color: green; font-weight: bold; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i> MoE-RAGã‚·ã‚¹ãƒ†ãƒ : ç¨¼åƒä¸­
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5 style="margin-top: 10px;">ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</h5>
                            <div style="font-size: 14px;">
                                <div>ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãƒ«ãƒ¼ã‚¿ãƒ¼: ${statusData.components.expert_router ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}</div>
                                <div>ãƒ¬ã‚¹ãƒãƒ³ã‚¹èåˆ: ${statusData.components.response_fusion ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}</div>
                                <div>æœ€çµ‚æ›´æ–°: ${new Date(statusData.timestamp).toLocaleTimeString('ja-JP')}</div>
                            </div>
                        </div>
            `;
            
            if (expertsData && expertsData.experts) {
                html += `
                        <div>
                            <h5 style="margin-top: 10px;">åˆ©ç”¨å¯èƒ½ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ (${expertsData.total})</h5>
                            <div style="font-size: 12px; max-height: 150px; overflow-y: auto;">
                `;
                
                expertsData.experts.forEach(expert => {
                    html += `
                        <div style="margin: 2px 0; padding: 3px 8px; background: #f0f0f0; border-radius: 4px; 
                                    border-left: 3px solid ${expert.color || '#999'};">
                            ${expert.icon || 'â€¢'} <strong>${expert.name}</strong>: ${expert.description}
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            statusDiv.innerHTML = html;
        } else {
            statusDiv.innerHTML = `
                <div style="padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ff9800;">
                    <div style="color: orange;">
                        <i class="fas fa-exclamation-triangle"></i> MoE-RAGã‚·ã‚¹ãƒ†ãƒ : åˆæœŸåŒ–ä¸­...
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading MoE status:', error);
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
            <div style="padding: 15px; background: #ffebee; border-radius: 8px; border: 1px solid #f44336;">
                <div style="color: red;">
                    <i class="fas fa-times-circle"></i> MoE-RAGã‚·ã‚¹ãƒ†ãƒ : ã‚¨ãƒ©ãƒ¼
                    <div style="font-size: 12px; margin-top: 5px;">${error.message}</div>
                </div>
            </div>
        `;
    }
}

// MoE UIå±•é–‹/æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
function toggleMoEUI() {
    const embeddedUI = document.getElementById('embedded-moe-ui');
    const toggleBtn = document.getElementById('moe-ui-toggle-btn');
    
    if (embeddedUI.style.display === 'none' || embeddedUI.style.display === '') {
        // å±•é–‹
        embeddedUI.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-compress"></i> MoE-RAG Web UIã‚’æŠ˜ã‚ŠãŸãŸã‚€';
        
        // iframeå†èª­ã¿è¾¼ã¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        const iframe = document.getElementById('moe-ui-iframe');
        if (!iframe.src) {
            iframe.src = '/static/moe_rag_ui.html';
        }
        
        // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        embeddedUI.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // æŠ˜ã‚ŠãŸãŸã¿
        embeddedUI.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-expand"></i> MoE-RAG Web UIã‚’å±•é–‹';
    }
}

// ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†ç”»é¢ã‚’é–‹ã
function openMoETraining() {
    switchMoEView('training');
}

// MoE UIå†…ã®ãƒ“ãƒ¥ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
function switchMoEView(view) {
    const embeddedUI = document.getElementById('embedded-moe-ui');
    const iframe = document.getElementById('moe-ui-iframe');
    const toggleBtn = document.getElementById('moe-ui-toggle-btn');
    const titleElement = document.getElementById('moe-ui-title');
    
    // UIã‚’å±•é–‹
    embeddedUI.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-compress"></i> MoE-RAG Web UIã‚’æŠ˜ã‚ŠãŸãŸã‚€';
    
    // ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦iframeã®ã‚½ãƒ¼ã‚¹ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
    if (view === 'training') {
        iframe.src = '/static/moe_training.html';
        titleElement.innerHTML = 'ğŸ“ MoEãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†';
    } else {
        iframe.src = '/static/moe_rag_ui.html';
        titleElement.innerHTML = 'ğŸŒ MoE-RAGæ¤œç´¢ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹';
    }
    
    // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    embeddedUI.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function analyzeMoEQuery(event) {
    event.preventDefault();
    
    const query = document.getElementById('moe-query').value;
    if (!query) {
        alert('ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const resultDiv = document.getElementById('moe-analysis-result');
    resultDiv.innerHTML = '<div class="loading">åˆ†æä¸­...</div>';
    
    try {
        const response = await fetch(`/api/moe-rag/analyze?query=${encodeURIComponent(query)}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        let html = `
            <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                <h4>ã‚¯ã‚¨ãƒªåˆ†æçµæœ</h4>
                <div style="margin-top: 15px;">
                    <strong>é¸æŠã•ã‚ŒãŸã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ:</strong>
                    <div style="margin-top: 5px;">
        `;
        
        data.primary_experts.forEach(expert => {
            html += `<span style="display: inline-block; padding: 5px 10px; margin: 5px; 
                            background: #9b59b6; color: white; border-radius: 5px;">
                        ${expert}
                    </span>`;
        });
        
        html += `
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <strong>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥:</strong> ${data.routing_strategy}
                </div>
                <div style="margin-top: 15px;">
                    <strong>ä¿¡é ¼åº¦:</strong> 
                    <div style="display: inline-block; width: 200px; height: 20px; 
                                background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div style="width: ${data.confidence * 100}%; height: 100%; 
                                    background: linear-gradient(90deg, #f39c12, #27ae60);"></div>
                    </div>
                    ${(data.confidence * 100).toFixed(1)}%
                </div>
                <div style="margin-top: 15px;">
                    <strong>ã‚¯ã‚¨ãƒªè¤‡é›‘åº¦:</strong> ${(data.complexity.complexity_score * 100).toFixed(1)}%
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="executeQueryInEmbedded('${encodeURIComponent(query)}')" 
                       class="btn btn-primary" 
                       style="background: #9b59b6; border-color: #8e44ad;">
                        <i class="fas fa-search"></i> è©³ç´°æ¤œç´¢ã‚’å®Ÿè¡Œ
                    </button>
                </div>
            </div>
        `;
        
        resultDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Error analyzing query:', error);
        resultDiv.innerHTML = `
            <div style="color: red; padding: 15px; background: #fee; border-radius: 8px;">
                <i class="fas fa-times-circle"></i> ã‚¨ãƒ©ãƒ¼: ${error.message}
            </div>
        `;
    }
}

// åŸ‹ã‚è¾¼ã¿UIã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
function executeQueryInEmbedded(encodedQuery) {
    const embeddedUI = document.getElementById('embedded-moe-ui');
    const iframe = document.getElementById('moe-ui-iframe');
    const toggleBtn = document.getElementById('moe-ui-toggle-btn');
    
    // UIã‚’å±•é–‹
    embeddedUI.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-compress"></i> MoE-RAG Web UIã‚’æŠ˜ã‚ŠãŸãŸã‚€';
    
    // ã‚¯ã‚¨ãƒªä»˜ãã§UIã‚’èª­ã¿è¾¼ã¿
    iframe.src = `/static/moe_rag_ui.html?query=${encodedQuery}`;
    
    // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    embeddedUI.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
{% endblock %} 