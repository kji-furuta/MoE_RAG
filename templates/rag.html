{% extends "base.html" %}

{% block title %}RAG System - AI Fine-tuning Toolkit{% endblock %}

{% block content %}
<style>
    /* RAGãƒšãƒ¼ã‚¸å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .rag-container {
        padding-left: 40px;
        padding-right: 40px;
        padding-top: 20px;
    }
    
    .rag-container h1 {
        margin-bottom: 30px;
        padding-left: 10px;
    }
    
    .nav-tabs {
        margin-left: 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
        padding: 10px 20px;
        border-radius: 5px 5px 0 0;
    }
    
    .tab-content {
        padding-top: 20px;
    }
    
    .card {
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-body {
        padding: 25px;
    }
    
    .form-control, .btn {
        margin-left: 0;
    }
    
    .form-label {
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .table {
        margin-left: 0;
        width: 100%;
    }
    
    /* ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .alert {
        margin-left: 0;
        margin-right: 0;
        padding: 15px 20px;
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®é–“éš” */
    .mb-3 {
        margin-bottom: 1.5rem !important;
    }
    
    /* Bootstrapäº’æ›æ€§ã®ãŸã‚ã®èª¿æ•´ */
    .row {
        margin-left: -15px;
        margin-right: -15px;
    }
    
    .col-md-4 {
        padding-left: 15px;
        padding-right: 15px;
    }
</style>

<div class="container rag-container">
    <h1>ğŸ—ï¸ åœŸæœ¨é“è·¯è¨­è¨ˆç‰¹åŒ–å‹RAGã‚·ã‚¹ãƒ†ãƒ </h1>
    
    {% if not rag_available %}
    <div class="alert alert-warning">
        <h3>âš ï¸ RAGã‚·ã‚¹ãƒ†ãƒ ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“</h3>
        <p>RAGã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
        <p>ä»¥ä¸‹ã‚’ãŠè©¦ã—ãã ã•ã„ï¼š</p>
        <ul>
            <li>Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„</li>
            <li>æ—¢å­˜ã®Qdrantãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ã—ã¦ãã ã•ã„</li>
            <li>ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: <code>docker logs ai-ft-container</code></li>
        </ul>
        <p>è©³ç´°: Qdrantãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™</p>
    </div>
    {% else %}
    
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#settings">âš™ï¸ ãƒ¢ãƒ‡ãƒ«è¨­å®š</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#upload">ğŸ“¤ æ–‡æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#search">ğŸ” æ¤œç´¢ãƒ»è³ªå•å¿œç­”</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#documents">ğŸ“š æ–‡æ›¸ç®¡ç†</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#statistics">ğŸ“Š çµ±è¨ˆæƒ…å ±</a>
        </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content">
        <!-- ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚¿ãƒ– -->
        <div class="tab-pane fade show active" id="settings">
            <div class="card">
                <div class="card-body">
                    <h3>âš™ï¸ RAGã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                    
                    <div class="mb-4">
                        <h4>ğŸ¤– ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«</h4>
                        <form id="modelSettingsForm">
                            <div class="mb-3">
                                <label for="ragModel" class="form-label">LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰é¸æŠ</label>
                                <select class="form-control" id="ragModel" name="model">
                                    <option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
                                    <optgroup label="ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«">
                                        <!-- å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                                    </optgroup>
                                    <optgroup label="ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«">
                                        <option value="cyberagent/calm3-22b-chat">CALM3-22B-Chat (æ—¥æœ¬èªç‰¹åŒ–)</option>
                                        <option value="microsoft/Phi-3.5-mini-instruct">Phi-3.5-mini (è»½é‡)</option>
                                        <option value="meta-llama/Llama-2-7b-chat-hf">Llama-2-7B-Chat</option>
                                    </optgroup>
                                </select>
                                <small class="form-text text-muted">
                                    ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åœŸæœ¨é“è·¯è¨­è¨ˆã«ç‰¹åŒ–ã—ãŸå›ç­”ãŒå¾—ã‚‰ã‚Œã¾ã™
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="embeddingModel" class="form-label">åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«</label>
                                <select class="form-control" id="embeddingModel" name="embedding_model">
                                    <option value="intfloat/multilingual-e5-large" selected>Multilingual-E5-Large (æ¨å¥¨)</option>
                                    <option value="sentence-transformers/all-MiniLM-L6-v2">All-MiniLM-L6-v2 (é«˜é€Ÿ)</option>
                                    <option value="BAAI/bge-base-ja-v1.5">BGE-Base-JA (æ—¥æœ¬èªç‰¹åŒ–)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="temperature" class="form-label">Temperature (å‰µé€ æ€§)</label>
                                <input type="range" class="form-control-range" id="temperature" 
                                       name="temperature" min="0" max="1" step="0.1" value="0.3">
                                <span id="tempValue">0.3</span>
                                <small class="form-text text-muted">
                                    ä½ã„å€¤: ã‚ˆã‚Šæ­£ç¢ºã§ä¸€è²«æ€§ã®ã‚ã‚‹å›ç­” / é«˜ã„å€¤: ã‚ˆã‚Šå‰µé€ çš„ãªå›ç­”
                                </small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">è¨­å®šã‚’ä¿å­˜</button>
                            <div id="modelSettingsResult" class="mt-3"></div>
                        </form>
                    </div>
                    
                    <div class="mt-4">
                        <h4>ğŸ“Š ç¾åœ¨ã®è¨­å®š</h4>
                        <div id="currentSettings" class="alert alert-info">
                            èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="upload">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ“¤ PDFæ–‡æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".pdf" required>
                        </div>
                        <div class="mb-3">
                            <label for="title" class="form-label">æ–‡æ›¸ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
                            <select class="form-control" id="category" name="category" required>
                                <option value="é“è·¯æ§‹é€ ä»¤">é“è·¯æ§‹é€ ä»¤</option>
                                <option value="è¨­è¨ˆåŸºæº–">è¨­è¨ˆåŸºæº–</option>
                                <option value="æŠ€è¡“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«">æŠ€è¡“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</option>
                                <option value="ä»•æ§˜æ›¸">ä»•æ§˜æ›¸</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                    </form>
                    <div id="uploadResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- æ¤œç´¢ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="search">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ” ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ãƒ»è³ªå•å¿œç­”</h3>
                    <form id="searchForm">
                        <div class="mb-3">
                            <label for="query" class="form-label">æ¤œç´¢ã‚¯ã‚¨ãƒªãƒ»è³ªå•</label>
                            <textarea class="form-control" id="query" rows="3" required
                                placeholder="ä¾‹: è¨­è¨ˆé€Ÿåº¦60km/hã®é“è·¯ã®æœ€å°æ›²ç·šåŠå¾„ã¯ï¼Ÿ"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="searchType" class="form-label">æ¤œç´¢ã‚¿ã‚¤ãƒ—</label>
                            <select class="form-control" id="searchType">
                                <option value="hybrid">ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆæ¨å¥¨ï¼‰</option>
                                <option value="vector">ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢</option>
                                <option value="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="topK" class="form-label">æ¤œç´¢çµæœæ•°</label>
                            <input type="number" class="form-control" id="topK" value="5" min="1" max="20">
                        </div>
                        <button type="submit" class="btn btn-primary">æ¤œç´¢</button>
                    </form>
                    <div id="searchResult" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- æ–‡æ›¸ç®¡ç†ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="documents">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ“š æ–‡æ›¸ä¸€è¦§</h3>
                    <button class="btn btn-secondary mb-3" onclick="loadDocuments()">æ›´æ–°</button>
                    <div id="documentsList"></div>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆã‚¿ãƒ– -->
        <div class="tab-pane fade" id="statistics">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h3>
                    <button class="btn btn-secondary mb-3" onclick="loadStatistics()">æ›´æ–°</button>
                    <div id="statisticsData"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ 
document.getElementById('uploadForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('uploadResult');
    
    resultDiv.innerHTML = '<div class="alert alert-info">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>';
    
    try {
        const response = await fetch('/rag/upload-document', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h4>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ</h4>
                    <p>æ–‡æ›¸ID: ${data.document_id}</p>
                    <p>å‡¦ç†ã•ã‚ŒãŸãƒšãƒ¼ã‚¸æ•°: ${data.metadata.page_count}</p>
                </div>
            `;
        } else {
            throw new Error(data.detail || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼');
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                ã‚¨ãƒ©ãƒ¼: ${error.message}
            </div>
        `;
    }
});

// æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ 
document.getElementById('searchForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const query = document.getElementById('query').value;
    const searchType = document.getElementById('searchType').value;
    const topK = document.getElementById('topK').value;
    const resultDiv = document.getElementById('searchResult');
    
    resultDiv.innerHTML = '<div class="alert alert-info">æ¤œç´¢ä¸­...</div>';
    
    try {
        const response = await fetch('/rag/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: query,
                search_type: searchType,
                top_k: parseInt(topK)
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            let html = '<div class="card mt-3">';
            html += '<div class="card-body">';
            html += `<h4>å›ç­”</h4><p>${data.answer}</p>`;
            
            if (data.sources && data.sources.length > 0) {
                html += '<h5 class="mt-3">å‚ç…§å…ƒ</h5>';
                html += '<ul>';
                data.sources.forEach(source => {
                    const score = source.score !== undefined ? source.score.toFixed(3) : 'N/A';
                    html += `<li>${source.title} (ã‚¹ã‚³ã‚¢: ${score})</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div></div>';
            resultDiv.innerHTML = html;
        } else {
            throw new Error(data.detail || 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼');
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                ã‚¨ãƒ©ãƒ¼: ${error.message}
            </div>
        `;
    }
});

// æ–‡æ›¸ä¸€è¦§å–å¾—
async function loadDocuments() {
    const listDiv = document.getElementById('documentsList');
    listDiv.innerHTML = '<div class="alert alert-info">èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    try {
        const response = await fetch('/rag/documents');
        const data = await response.json();
        
        if (response.ok && data.documents) {
            let html = '<table class="table">';
            html += '<thead><tr><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ãƒšãƒ¼ã‚¸æ•°</th><th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead>';
            html += '<tbody>';
            
            data.documents.forEach(doc => {
                html += `<tr id="doc-row-${doc.id}">
                    <td>${doc.title}</td>
                    <td>${doc.category}</td>
                    <td>${doc.page_count || '-'}</td>
                    <td>${new Date(doc.created_at).toLocaleString('ja-JP')}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.id}', '${doc.title}')">
                            å‰Šé™¤
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        } else {
            throw new Error('æ–‡æ›¸ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        listDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

// æ–‡æ›¸å‰Šé™¤
async function deleteDocument(docId, docTitle) {
    if (!confirm(`æ–‡æ›¸ã€Œ${docTitle}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }
    
    try {
        const response = await fetch(`/rag/documents/${docId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <strong>å‰Šé™¤æˆåŠŸ:</strong> ${data.document_title} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('documentsList').insertBefore(alertDiv, document.getElementById('documentsList').firstChild);
            
            // è¡Œã‚’å‰Šé™¤
            const row = document.getElementById(`doc-row-${docId}`);
            if (row) {
                row.style.transition = 'opacity 0.5s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 500);
            }
        } else {
            throw new Error(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        alert(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

// çµ±è¨ˆæƒ…å ±å–å¾—
async function loadStatistics() {
    const statsDiv = document.getElementById('statisticsData');
    statsDiv.innerHTML = '<div class="alert alert-info">èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    try {
        const response = await fetch('/rag/statistics');
        const data = await response.json();
        
        if (response.ok) {
            let html = '<div class="row">';
            html += `
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>ç·æ–‡æ›¸æ•°</h5>
                            <h2>${data.total_documents || 0}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>ç·ãƒãƒ£ãƒ³ã‚¯æ•°</h5>
                            <h2>${data.total_chunks || 0}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º</h5>
                            <h2>${data.index_size || 'N/A'}</h2>
                        </div>
                    </div>
                </div>
            `;
            html += '</div>';
            statsDiv.innerHTML = html;
        } else {
            throw new Error('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        statsDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

// Temperature ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’è¡¨ç¤º
document.getElementById('temperature')?.addEventListener('input', (e) => {
    document.getElementById('tempValue').textContent = e.target.value;
});

// ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€
async function loadFinetunedModels() {
    try {
        const response = await fetch('/api/available-models');
        const data = await response.json();
        
        const select = document.getElementById('ragModel');
        const optgroup = select.querySelector('optgroup[label="ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«"]');
        
        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
        optgroup.innerHTML = '';
        
        if (data.finetuned_models && data.finetuned_models.length > 0) {
            data.finetuned_models.forEach(model => {
                const option = document.createElement('option');
                option.value = `finetuned:${model.path}`;
                option.textContent = `${model.name} (${model.base_model || 'Unknown'}) - ${model.created_at}`;
                optgroup.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“';
            option.disabled = true;
            optgroup.appendChild(option);
        }
    } catch (error) {
        console.error('Failed to load models:', error);
    }
}

// ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
async function loadCurrentSettings() {
    try {
        const response = await fetch('/rag/system-info');
        const data = await response.json();
        
        const settingsDiv = document.getElementById('currentSettings');
        if (data.config) {
            let html = '<table class="table table-sm">';
            html += `<tr><td>LLMãƒ¢ãƒ‡ãƒ«:</td><td>${data.config.llm?.model_name || 'æœªè¨­å®š'}</td></tr>`;
            html += `<tr><td>åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«:</td><td>${data.config.embedding?.model_name || 'multilingual-e5-large'}</td></tr>`;
            html += `<tr><td>Temperature:</td><td>${data.config.llm?.temperature || 0.3}</td></tr>`;
            html += `<tr><td>ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢:</td><td>${data.config.vector_store?.type || 'Qdrant'}</td></tr>`;
            html += '</table>';
            settingsDiv.innerHTML = html;
        }
    } catch (error) {
        document.getElementById('currentSettings').innerHTML = 
            '<div class="text-muted">è¨­å®šæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
    }
}

// ãƒ¢ãƒ‡ãƒ«è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
document.getElementById('modelSettingsForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('modelSettingsResult');
    
    resultDiv.innerHTML = '<div class="alert alert-info">è¨­å®šã‚’ä¿å­˜ä¸­...</div>';
    
    try {
        const settings = {
            llm_model: formData.get('model'),
            embedding_model: formData.get('embedding_model'),
            temperature: parseFloat(formData.get('temperature'))
        };
        
        const response = await fetch('/rag/update-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            resultDiv.innerHTML = '<div class="alert alert-success">è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚RAGã‚·ã‚¹ãƒ†ãƒ ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚</div>';
            loadCurrentSettings();
        } else {
            throw new Error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', () => {
    if (!{{ 'true' if rag_available else 'false' }}) {
        return;
    }
    loadFinetunedModels();
    loadCurrentSettings();
});
</script>
{% endblock %}