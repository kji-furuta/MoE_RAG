{% extends "base.html" %}

{% block title %}RAG System - AI Fine-tuning Toolkit{% endblock %}

{% block content %}
<style>
    /* RAGãƒšãƒ¼ã‚¸å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .rag-container {
        padding-left: 40px;
        padding-right: 40px;
        padding-top: 20px;
    }
    
    .rag-container h1 {
        margin-bottom: 30px;
        padding-left: 10px;
    }
    
    .nav-tabs {
        margin-left: 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #b3ecb1;
    }
    
    .nav-tabs .nav-link {
        padding: 10px 20px;
        border-radius: 5px 5px 0 0;
        color: #4d0505 !important;  /* ã‚¿ãƒ–ã®æ–‡å­—ã‚’é»’è‰²ã« */
        font-weight: 500;
    }
    
    .nav-tabs .nav-link:hover {
        color: #fc0b03 !important;  /* ãƒ›ãƒãƒ¼æ™‚ã‚‚é»’ç³»çµ± */
    }
    
    .nav-tabs .nav-link.active {
        color: #1403fc !important;  /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã‚‚é»’è‰² */
        font-weight: 600;
        background-color: #a4e3ee;
        border-color: #dee2e6 #dee2e6 #fff;
    }
    
    .tab-content {
        padding-top: 20px;
    }
    
    .card {
        margin-bottom: 20px;
        border: 1px solid #b0cfee;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card-body {
        padding: 25px;
    }
    
    .form-control, .btn {
        margin-left: 0;
    }
    
    .form-label {
        margin-bottom: 8px;
        font-weight: 600;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .table {
        margin-left: 0;
        width: 100%;
    }
    
    /* ã‚¢ãƒ©ãƒ¼ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .alert {
        margin-left: 0;
        margin-right: 0;
        padding: 15px 20px;
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®é–“éš” */
    .mb-3 {
        margin-bottom: 1.5rem !important;
    }
    
    /* Bootstrapäº’æ›æ€§ã®ãŸã‚ã®èª¿æ•´ */
    .row {
        margin-left: -15px;
        margin-right: -15px;
    }
    
    .col-md-4 {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    /* å›ç­”è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .answer-content {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 10px;
    }
    
    .citations-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .citations-list .card {
        border: 1px solid #bb8c8c;
        box-shadow: none;
    }
    
    .citations-list .card:hover {
        background-color: #e7b7b7;
    }
</style>

<div class="container rag-container">
    <h1>ğŸ—ï¸ åœŸæœ¨é“è·¯è¨­è¨ˆç‰¹åŒ–å‹RAGã‚·ã‚¹ãƒ†ãƒ </h1>
    
    {% if not rag_available %}
    <div class="alert alert-warning">
        <h3>âš ï¸ RAGã‚·ã‚¹ãƒ†ãƒ ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“</h3>
        <p>RAGã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
        <p>ä»¥ä¸‹ã‚’ãŠè©¦ã—ãã ã•ã„ï¼š</p>
        <ul>
            <li>Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„</li>
            <li>æ—¢å­˜ã®Qdrantãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ã—ã¦ãã ã•ã„</li>
            <li>ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: <code>docker logs ai-ft-container</code></li>
        </ul>
        <p>è©³ç´°: Qdrantãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™</p>
    </div>
    {% else %}
    
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#settings">âš™ï¸ ãƒ¢ãƒ‡ãƒ«è¨­å®š</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#upload">ğŸ“¤ æ–‡æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#search">ğŸ” æ¤œç´¢ãƒ»è³ªå•å¿œç­”</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#documents">ğŸ“š æ–‡æ›¸ç®¡ç†</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#statistics">ğŸ“Š çµ±è¨ˆæƒ…å ±</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#history">ğŸ“‹ æ¤œç´¢å±¥æ­´</a>
        </li>
    </ul>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content">
        <!-- ãƒ¢ãƒ‡ãƒ«è¨­å®šã‚¿ãƒ– -->
        <div class="tab-pane fade show active" id="settings">
            <div class="card">
                <div class="card-body">
                    <h3>âš™ï¸ RAGã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                    
                    <div class="mb-4">
                        <h4>ğŸ¤– ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«</h4>
                        <form id="modelSettingsForm">
                            <div class="mb-3">
                                <label for="ragModel" class="form-label">LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰é¸æŠ</label>
                                <select class="form-control" id="ragModel" name="model">
                                    <option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
                                    <optgroup label="MoEï¼ˆMixture of Expertsï¼‰ãƒ¢ãƒ‡ãƒ«">
                                        <!-- MoEãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                                    </optgroup>
                                    <optgroup label="ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«">
                                        <!-- å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                                    </optgroup>
                                    <optgroup label="ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«">
                                        <option value="cyberagent/calm3-22b-chat">CALM3-22B-Chat (æ—¥æœ¬èªç‰¹åŒ–)</option>
                                        <option value="microsoft/Phi-3.5-mini-instruct">Phi-3.5-mini (è»½é‡)</option>
                                        <option value="meta-llama/Llama-2-7b-chat-hf">Llama-2-7B-Chat</option>
                                    </optgroup>
                                </select>
                                <small class="form-text text-muted">
                                    ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åœŸæœ¨é“è·¯è¨­è¨ˆã«ç‰¹åŒ–ã—ãŸå›ç­”ãŒå¾—ã‚‰ã‚Œã¾ã™
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="embeddingModel" class="form-label">åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«</label>
                                <select class="form-control" id="embeddingModel" name="embedding_model">
                                    <option value="intfloat/multilingual-e5-large" selected>Multilingual-E5-Large (æ¨å¥¨)</option>
                                    <option value="sentence-transformers/all-MiniLM-L6-v2">All-MiniLM-L6-v2 (é«˜é€Ÿ)</option>
                                    <option value="BAAI/bge-base-ja-v1.5">BGE-Base-JA (æ—¥æœ¬èªç‰¹åŒ–)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="temperature" class="form-label">Temperature (å‰µé€ æ€§)</label>
                                <input type="range" class="form-control-range" id="temperature" 
                                       name="temperature" min="0" max="1" step="0.1" value="0.3">
                                <span id="tempValue">0.3</span>
                                <small class="form-text text-muted">
                                    ä½ã„å€¤: ã‚ˆã‚Šæ­£ç¢ºã§ä¸€è²«æ€§ã®ã‚ã‚‹å›ç­” / é«˜ã„å€¤: ã‚ˆã‚Šå‰µé€ çš„ãªå›ç­”
                                </small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">è¨­å®šã‚’ä¿å­˜</button>
                            <div id="modelSettingsResult" class="mt-3"></div>
                        </form>
                    </div>
                    
                    <div class="mt-4">
                        <h4>ğŸ“Š ç¾åœ¨ã®è¨­å®š</h4>
                        <div id="currentSettings" class="alert alert-info">
                            èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="upload">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ“¤ PDFæ–‡æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".pdf" required>
                        </div>
                        <div class="mb-3">
                            <label for="title" class="form-label">æ–‡æ›¸ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
                            <select class="form-control" id="category" name="category" required>
                                <option value="é“è·¯æ§‹é€ ä»¤">é“è·¯æ§‹é€ ä»¤</option>
                                <option value="è¨­è¨ˆåŸºæº–">è¨­è¨ˆåŸºæº–</option>
                                <option value="æŠ€è¡“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«">æŠ€è¡“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</option>
                                <option value="ä»•æ§˜æ›¸">ä»•æ§˜æ›¸</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                    </form>
                    <div id="uploadResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- æ¤œç´¢ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="search">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ” ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ãƒ»è³ªå•å¿œç­”</h3>
                    
                    <!-- æ–‡æ›¸é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <h5>ğŸ“„ æ¤œç´¢å¯¾è±¡æ–‡æ›¸ã®é¸æŠ</h5>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAllDocuments" checked>
                                <label class="form-check-label" for="selectAllDocuments">
                                    <strong>ã™ã¹ã¦ã®æ–‡æ›¸ã‚’é¸æŠ</strong>
                                </label>
                            </div>
                            <div id="documentCheckboxList" class="row"></div>
                            <small class="text-muted">â€»é¸æŠã•ã‚ŒãŸæ–‡æ›¸ã®ã¿ã‹ã‚‰æ¤œç´¢ã•ã‚Œã¾ã™</small>
                        </div>
                    </div>
                    
                    <form id="searchForm">
                        <div class="mb-3">
                            <label for="query" class="form-label">æ¤œç´¢ã‚¯ã‚¨ãƒªãƒ»è³ªå•</label>
                            <textarea class="form-control" id="query" rows="3" required
                                placeholder="ä¾‹: è¨­è¨ˆé€Ÿåº¦60km/hã®é“è·¯ã®æœ€å°æ›²ç·šåŠå¾„ã¯ï¼Ÿ"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="searchType" class="form-label">æ¤œç´¢ã‚¿ã‚¤ãƒ—</label>
                            <select class="form-control" id="searchType">
                                <option value="hybrid">ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ï¼ˆæ¨å¥¨ï¼‰</option>
                                <option value="vector">ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢</option>
                                <option value="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="topK" class="form-label">æ¤œç´¢çµæœæ•°</label>
                            <input type="number" class="form-control" id="topK" value="5" min="1" max="20">
                        </div>
                        <button type="submit" class="btn btn-primary">æ¤œç´¢</button>
                    </form>
                    <div id="searchResult" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- æ–‡æ›¸ç®¡ç†ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="documents">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ“š æ–‡æ›¸ä¸€è¦§</h3>
                    <button class="btn btn-secondary mb-3" onclick="loadDocuments()">æ›´æ–°</button>
                    <div id="documentsList"></div>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆã‚¿ãƒ– -->
        <div class="tab-pane fade" id="statistics">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h3>
                    <button class="btn btn-secondary mb-3" onclick="loadStatistics()">æ›´æ–°</button>
                    <div id="statisticsData"></div>
                </div>
            </div>
        </div>

        <!-- æ¤œç´¢å±¥æ­´ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="history">
            <div class="card">
                <div class="card-body">
                    <h3>ğŸ“‹ æ¤œç´¢å±¥æ­´</h3>
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="loadSearchHistory()">
                            <i class="bi bi-arrow-clockwise"></i> å±¥æ­´ã‚’æ›´æ–°
                        </button>
                        <button class="btn btn-success" onclick="exportAllHistory()">
                            <i class="bi bi-download"></i> å…¨å±¥æ­´ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button class="btn btn-danger float-end" onclick="clearAllSearchHistory()">
                            <i class="bi bi-trash"></i> å…¨å±¥æ­´ã‚’å‰Šé™¤
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tagFilter" class="form-label">ã‚¿ã‚°ã§ãƒ•ã‚£ãƒ«ã‚¿</label>
                        <select class="form-control" id="tagFilter" onchange="loadSearchHistory()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    
                    <div id="historyList">
                        <div class="text-muted">ã€Œå±¥æ­´ã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
                    </div>
                    
                    <nav aria-label="å±¥æ­´ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³">
                        <ul class="pagination justify-content-center" id="historyPagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ 
document.getElementById('uploadForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('uploadResult');
    
    resultDiv.innerHTML = '<div class="alert alert-info">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>';
    
    try {
        const response = await fetch('/rag/upload-document', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯æˆåŠŸã€å‡¦ç†çŠ¶æ³ã‚’ç›£è¦–
            const documentId = data.document_id;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <h4>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº† - å‡¦ç†ä¸­...</h4>
                    <p>æ–‡æ›¸ID: ${documentId}</p>
                    <div class="progress">
                        <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <p id="statusMessage" class="mt-2">åˆæœŸåŒ–ä¸­...</p>
                </div>
            `;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯é–¢æ•°
            async function checkStatus() {
                try {
                    const statusResponse = await fetch(`/rag/upload-status/${documentId}`);
                    const statusData = await statusResponse.json();
                    
                    const progressBar = document.getElementById('uploadProgress');
                    const statusMsg = document.getElementById('statusMessage');
                    
                    if (progressBar && statusMsg) {
                        progressBar.style.width = `${statusData.progress}%`;
                        progressBar.textContent = `${statusData.progress}%`;
                        statusMsg.textContent = statusData.message || 'å‡¦ç†ä¸­...';
                        
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦å‡¦ç†
                        if (statusData.status === 'completed') {
                            resultDiv.innerHTML = `
                                <div class="alert alert-success">
                                    <h4>âœ… å‡¦ç†å®Œäº†</h4>
                                    <p>æ–‡æ›¸ID: ${documentId}</p>
                                    <p>${statusData.message}</p>
                                </div>
                            `;
                            // æ–‡æ›¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            await loadDocumentCheckboxList();
                            if (typeof loadDocuments === 'function') {
                                await loadDocuments();
                            }
                            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                            e.target.reset();
                            return true; // å®Œäº†
                        } else if (statusData.status === 'error' || statusData.status === 'timeout') {
                            resultDiv.innerHTML = `
                                <div class="alert alert-danger">
                                    <h4>âŒ å‡¦ç†ã‚¨ãƒ©ãƒ¼</h4>
                                    <p>æ–‡æ›¸ID: ${documentId}</p>
                                    <p>${statusData.message}</p>
                                </div>
                            `;
                            return true; // ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†
                        }
                    }
                    return false; // ç¶™ç¶š
                } catch (error) {
                    console.error('Status check error:', error);
                    return false; // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶™ç¶š
                }
            }
            
            // å®šæœŸçš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
            const intervalId = setInterval(async () => {
                const isComplete = await checkStatus();
                if (isComplete) {
                    clearInterval(intervalId);
                }
            }, 2000); // 2ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
            
            // æœ€å¤§20åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                clearInterval(intervalId);
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h4>âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</h4>
                        <p>å‡¦ç†ã®ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‡¦ç†ãŒç¶™ç¶šã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
                    </div>
                `;
            }, 1200000); // 20åˆ†
            
        } else {
            throw new Error(data.detail || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼');
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                ã‚¨ãƒ©ãƒ¼: ${error.message}
            </div>
        `;
    }
});

// æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ 
document.getElementById('searchForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const query = document.getElementById('query').value;
    const searchType = document.getElementById('searchType').value;
    const topK = document.getElementById('topK').value;
    const resultDiv = document.getElementById('searchResult');
    
    // é¸æŠã•ã‚ŒãŸæ–‡æ›¸IDã‚’å–å¾—
    const selectedDocuments = [];
    const selectAllCheckbox = document.getElementById('selectAllDocuments');
    
    // ã€Œã™ã¹ã¦ã®æ–‡æ›¸ã‚’é¸æŠã€ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€document_idsã‚’é€ä¿¡ã—ãªã„ï¼ˆå…¨æ–‡æ›¸ãŒå¯¾è±¡ï¼‰
    if (!selectAllCheckbox || !selectAllCheckbox.checked) {
        // å€‹åˆ¥é¸æŠã•ã‚Œã¦ã„ã‚‹æ–‡æ›¸ã®ã¿ã‚’å–å¾—
        const checkboxes = document.querySelectorAll('.document-checkbox:checked');
        checkboxes.forEach(checkbox => {
            selectedDocuments.push(checkbox.value);
        });
        
        // ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯è­¦å‘Š
        if (selectedDocuments.length === 0) {
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <strong>âš ï¸ æ–‡æ›¸ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</strong><br>
                    æ¤œç´¢å¯¾è±¡ã®æ–‡æ›¸ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                </div>
            `;
            return;
        }
    }
    
    resultDiv.innerHTML = '<div class="alert alert-info">æ¤œç´¢ä¸­...</div>';
    
    try {
        const requestBody = {
            query: query,
            search_type: searchType,
            top_k: parseInt(topK),
            include_sources: true
        };
        
        // ç‰¹å®šã®æ–‡æ›¸ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿document_idsã‚’è¿½åŠ 
        // ã€Œã™ã¹ã¦ã®æ–‡æ›¸ã‚’é¸æŠã€ã®å ´åˆã¯document_idsã‚’é€ä¿¡ã—ãªã„
        if (selectedDocuments.length > 0) {
            requestBody.document_ids = selectedDocuments;
            console.log('Filtering by documents:', selectedDocuments);
        } else {
            console.log('Searching all documents');
        }
        
        const response = await fetch('/rag/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            displaySearchResult(data);
        } else {
            throw new Error(data.detail || 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼');
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                ã‚¨ãƒ©ãƒ¼: ${error.message}
            </div>
        `;
    }
});

// æ–‡æ›¸ä¸€è¦§å–å¾—
async function loadDocuments() {
    const listDiv = document.getElementById('documentsList');
    listDiv.innerHTML = '<div class="alert alert-info">èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    try {
        const response = await fetch('/rag/documents');
        const data = await response.json();
        
        if (response.ok && data.documents) {
            let html = '<table class="table">';
            html += '<thead><tr><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ãƒšãƒ¼ã‚¸æ•°</th><th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead>';
            html += '<tbody>';
            
            data.documents.forEach(doc => {
                // æ—¥æ™‚ã®å–å¾—ï¼ˆcreated_at ã¾ãŸã¯ processing_timestamp ã‚’ä½¿ç”¨ï¼‰
                let uploadDate = '-';
                if (doc.created_at) {
                    // ISOãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¾ãŸã¯é€šå¸¸ã®æ—¥æ™‚å½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹
                    const date = new Date(doc.created_at);
                    if (!isNaN(date)) {
                        uploadDate = date.toLocaleString('ja-JP', { 
                            timeZone: 'Asia/Tokyo',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    }
                } else if (doc.processing_timestamp) {
                    const date = new Date(doc.processing_timestamp);
                    if (!isNaN(date)) {
                        uploadDate = date.toLocaleString('ja-JP', { 
                            timeZone: 'Asia/Tokyo',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    }
                }
                
                html += `<tr id="doc-row-${doc.id}">
                    <td>${doc.title}</td>
                    <td>${doc.category}</td>
                    <td>${doc.page_count || '-'}</td>
                    <td>${uploadDate}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${doc.id}', '${doc.title}')">
                            å‰Šé™¤
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        } else {
            throw new Error('æ–‡æ›¸ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        listDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

// æ–‡æ›¸å‰Šé™¤
async function deleteDocument(docId, docTitle) {
    if (!confirm(`æ–‡æ›¸ã€Œ${docTitle}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }
    
    try {
        const response = await fetch(`/rag/documents/${docId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <strong>å‰Šé™¤æˆåŠŸ:</strong> ${data.document_title} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('documentsList').insertBefore(alertDiv, document.getElementById('documentsList').firstChild);
            
            // è¡Œã‚’å‰Šé™¤
            const row = document.getElementById(`doc-row-${docId}`);
            if (row) {
                row.style.transition = 'opacity 0.5s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 500);
            }
        } else {
            throw new Error(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        alert(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

// çµ±è¨ˆæƒ…å ±å–å¾—
async function loadStatistics() {
    const statsDiv = document.getElementById('statisticsData');
    statsDiv.innerHTML = '<div class="alert alert-info">èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    try {
        const response = await fetch('/rag/statistics');
        const data = await response.json();
        
        if (response.ok) {
            let html = '<div class="row">';
            html += `
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>ç·æ–‡æ›¸æ•°</h5>
                            <h2>${data.total_documents || 0}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>ç·ãƒãƒ£ãƒ³ã‚¯æ•°</h5>
                            <h2>${data.total_chunks || 0}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º</h5>
                            <h2>${data.index_size || 'N/A'}</h2>
                        </div>
                    </div>
                </div>
            `;
            html += '</div>';
            statsDiv.innerHTML = html;
        } else {
            throw new Error('çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        statsDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

// Temperature ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’è¡¨ç¤º
document.getElementById('temperature')?.addEventListener('input', (e) => {
    document.getElementById('tempValue').textContent = e.target.value;
});

// ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¨MoEãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€
async function loadFinetunedModels() {
    try {
        // ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—
        const response = await fetch('/api/available-models');
        const data = await response.json();
        
        const select = document.getElementById('ragModel');
        const finetunedOptgroup = select.querySelector('optgroup[label="ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«"]');
        const moeOptgroup = select.querySelector('optgroup[label="MoEï¼ˆMixture of Expertsï¼‰ãƒ¢ãƒ‡ãƒ«"]');
        
        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
        finetunedOptgroup.innerHTML = '';
        moeOptgroup.innerHTML = '';
        
        // MoEãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å±¥æ­´ã‚’å–å¾—
        try {
            const moeResponse = await fetch('/api/moe/training/history');
            const moeData = await moeResponse.json();
            
            if (moeData.history && moeData.history.length > 0) {
                // å®Œäº†ã—ãŸMoEãƒ¢ãƒ‡ãƒ«ã®ã¿è¡¨ç¤º
                const completedMoEModels = moeData.history.filter(task => task.status === 'completed');
                
                completedMoEModels.forEach(task => {
                    const option = document.createElement('option');
                    option.value = `moe:${task.task_id}`;
                    const experts = task.config.experts ? task.config.experts.join(', ') : 'å…¨ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ';
                    option.textContent = `MoE - ${task.config.training_type} (${experts}) - ${new Date(task.start_time).toLocaleDateString('ja-JP')}`;
                    moeOptgroup.appendChild(option);
                });
                
                if (completedMoEModels.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿MoEãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“';
                    option.disabled = true;
                    moeOptgroup.appendChild(option);
                }
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'MoEãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“';
                option.disabled = true;
                moeOptgroup.appendChild(option);
            }
        } catch (moeError) {
            console.error('MoEãƒ¢ãƒ‡ãƒ«ã®å–å¾—ã«å¤±æ•—:', moeError);
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'MoEãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            option.disabled = true;
            moeOptgroup.appendChild(option);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ï¼ˆç¶™ç¶šå­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚‚å«ã‚€ï¼‰
        if (data.finetuned_models && data.finetuned_models.length > 0) {
            data.finetuned_models.forEach(model => {
                const option = document.createElement('option');
                option.value = `finetuned:${model.path}`;
                
                // ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤ºåã‚’èª¿æ•´
                let displayName = model.name;
                if (model.type === 'ç¶™ç¶šå­¦ç¿’' || model.type === 'ç¶™ç¶šå­¦ç¿’ (EWC)') {
                    displayName = `[ç¶™ç¶šå­¦ç¿’] ${model.name}`;
                } else if (model.type === 'ãƒ•ãƒ«ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°') {
                    displayName = `[ãƒ•ãƒ«] ${model.name}`;
                } else if (model.type === 'LoRA' || model.type === 'QLoRA (4bit)') {
                    displayName = `[${model.type}] ${model.name}`;
                }
                
                option.textContent = `${displayName} (${model.base_model || 'Unknown'}) - ${model.created_at || ''}`;
                finetunedOptgroup.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“';
            option.disabled = true;
            finetunedOptgroup.appendChild(option);
        }
    } catch (error) {
        console.error('Failed to load models:', error);
    }
}

// ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
async function loadCurrentSettings() {
    try {
        console.log('Loading current settings...');
        const response = await fetch('/rag/system-info');
        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        const settingsDiv = document.getElementById('currentSettings');
        
        if (data.system_info && data.system_info.config) {
            const config = data.system_info.config;
            let html = '<table class="table table-sm">';
            
            // LLMãƒ¢ãƒ‡ãƒ«ã®è©³ç´°è¡¨ç¤º
            const modelName = config.llm?.model_name || 'æœªè¨­å®š';
            const isFinetunedModel = modelName.includes('outputs/') || modelName.includes('ãƒ•ãƒ«ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°');
            const isMoEModel = config.llm?.use_moe === true;
            
            let modelType = 'ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«';
            let badgeClass = 'bg-secondary';
            if (isMoEModel) {
                modelType = 'MoEãƒ¢ãƒ‡ãƒ«';
                badgeClass = 'bg-warning';
            } else if (isFinetunedModel) {
                modelType = 'ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿';
                badgeClass = 'bg-success';
            }
            
            html += `<tr><td><strong>ä½¿ç”¨ä¸­ã®LLMãƒ¢ãƒ‡ãƒ«:</strong></td><td><span class="badge ${badgeClass}">${modelType}</span><br><code>${modelName}</code></td></tr>`;
            
            // MoEè¨­å®šãŒã‚ã‚‹å ´åˆã¯è¿½åŠ æƒ…å ±ã‚’è¡¨ç¤º
            if (isMoEModel) {
                html += `<tr><td>MoEã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆæ•°:</td><td>${config.llm?.moe_num_experts || 8}</td></tr>`;
                html += `<tr><td>ãƒˆãƒ¼ã‚¯ãƒ³ã”ã¨ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ:</td><td>${config.llm?.moe_experts_per_token || 2}</td></tr>`;
            }
            
            html += `<tr><td>åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«:</td><td>${config.embedding?.model_name || 'multilingual-e5-large'}</td></tr>`;
            html += `<tr><td>Temperature:</td><td>${config.llm?.temperature || 0.3}</td></tr>`;
            html += `<tr><td>ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢:</td><td>${config.vector_store?.type || 'Qdrant'}</td></tr>`;
            html += `<tr><td>ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ä½¿ç”¨:</td><td><span class="badge ${config.llm?.use_finetuned ? 'bg-success' : 'bg-secondary'}">${config.llm?.use_finetuned ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span></td></tr>`;
            html += `<tr><td>MoEä½¿ç”¨:</td><td><span class="badge ${config.llm?.use_moe ? 'bg-warning' : 'bg-secondary'}">${config.llm?.use_moe ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span></td></tr>`;
            html += '</table>';
            settingsDiv.innerHTML = html;
            console.log('Settings loaded successfully');
        } else {
            console.error('Invalid response structure:', data);
            settingsDiv.innerHTML = '<div class="text-muted">è¨­å®šãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ãŒç„¡åŠ¹ã§ã™</div>';
        }
    } catch (error) {
        console.error('Failed to load settings:', error);
        document.getElementById('currentSettings').innerHTML = 
            `<div class="text-muted">è¨­å®šæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ${error.message}</div>`;
    }
}

// ãƒ¢ãƒ‡ãƒ«è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
document.getElementById('modelSettingsForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('modelSettingsResult');
    
    resultDiv.innerHTML = '<div class="alert alert-info">è¨­å®šã‚’ä¿å­˜ä¸­...</div>';
    
    try {
        const settings = {
            llm_model: formData.get('model'),
            embedding_model: formData.get('embedding_model'),
            temperature: parseFloat(formData.get('temperature'))
        };
        
        const response = await fetch('/rag/update-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            resultDiv.innerHTML = '<div class="alert alert-success">è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚RAGã‚·ã‚¹ãƒ†ãƒ ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚</div>';
            loadCurrentSettings();
        } else {
            throw new Error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
});

// æ¤œç´¢çµæœã‚’ä¿å­˜
async function saveSearchResult() {
    if (!window.lastSearchResult) {
        alert('ä¿å­˜ã™ã‚‹æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const name = prompt('ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆçœç•¥å¯ï¼‰:');
    const tags = prompt('ã‚¿ã‚°ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆçœç•¥å¯ï¼‰:');
    
    try {
        const response = await fetch('/rag/save-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query_response: window.lastSearchResult,
                name: name || null,
                tags: tags ? tags.split(',').map(t => t.trim()) : null
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            alert(`æ¤œç´¢çµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ (ID: ${data.result_id})`);
        } else {
            throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

// æ¤œç´¢å±¥æ­´ã‚’è¡¨ç¤º
async function showSearchHistory() {
    const modalHtml = `
        <div class="modal fade" id="searchHistoryModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ğŸ“‹ æ¤œç´¢å±¥æ­´</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="searchHistoryContent">
                        <div class="text-center">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                        <button type="button" class="btn btn-primary" onclick="exportSelectedResults()">é¸æŠã—ãŸçµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
    if (!document.getElementById('searchHistoryModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆDOMæ›´æ–°ã‚’å¾…ã¤ï¼‰
    setTimeout(() => {
        const modalElement = document.getElementById('searchHistoryModal');
        if (modalElement && typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            console.error('Bootstrap Modal not available');
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ¤œç´¢å±¥æ­´ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
            const historyTab = document.querySelector('a[href="#history"]');
            if (historyTab) {
                historyTab.click();
                loadSearchHistory();
            }
        }
    }, 100);
    
    // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    try {
        const response = await fetch('/rag/search-history?limit=20');
        const data = await response.json();
        
        let html = '<div class="table-responsive">';
        html += '<table class="table table-hover">';
        html += '<thead><tr>';
        html += '<th><input type="checkbox" id="selectAllHistory"></th>';
        html += '<th>ä¿å­˜å</th>';
        html += '<th>ã‚¯ã‚¨ãƒª</th>';
        html += '<th>ä¿¡é ¼åº¦</th>';
        html += '<th>ä¿å­˜æ—¥æ™‚</th>';
        html += '<th>æ“ä½œ</th>';
        html += '</tr></thead>';
        html += '<tbody>';
        
        data.results.forEach(result => {
            html += `<tr>`;
            html += `<td><input type="checkbox" class="history-checkbox" value="${result.id}"></td>`;
            html += `<td>${result.metadata?.name || '-'}</td>`;
            html += `<td>${result.query.substring(0, 50)}...</td>`;
            html += `<td>${(result.confidence_score * 100).toFixed(1)}%</td>`;
            html += `<td>${new Date(result.saved_at).toLocaleString('ja-JP', { 
                timeZone: 'Asia/Tokyo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })}</td>`;
            html += `<td><button class="btn btn-sm btn-info" onclick="viewSavedResult('${result.id}')">è©³ç´°</button></td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        
        document.getElementById('searchHistoryContent').innerHTML = html;
        
        // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†
        document.getElementById('selectAllHistory')?.addEventListener('change', (e) => {
            document.querySelectorAll('.history-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
        });
        
    } catch (error) {
        document.getElementById('searchHistoryContent').innerHTML = 
            `<div class="alert alert-danger">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
    }
}

// ä¿å­˜ã•ã‚ŒãŸçµæœã‚’è¡¨ç¤º
async function viewSavedResult(resultId) {
    try {
        const response = await fetch(`/rag/search-result/${resultId}`);
        const data = await response.json();
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ã€çµæœã‚’è¡¨ç¤º
        bootstrap.Modal.getInstance(document.getElementById('searchHistoryModal'))?.hide();
        
        // æ¤œç´¢çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã«çµæœã‚’è¡¨ç¤º
        const resultDiv = document.getElementById('searchResult');
        window.lastSearchResult = data;
        
        // æ—¢å­˜ã®è¡¨ç¤ºé–¢æ•°ã‚’å†åˆ©ç”¨ï¼ˆãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’èª¿æ•´ï¼‰
        const formattedData = {
            query: data.query,
            answer: data.answer,
            citations: data.citations,
            sources: data.sources,
            confidence_score: data.confidence_score,
            processing_time: data.metadata?.processing_time || 0,
            metadata: data.metadata || {}
        };
        
        // çµæœã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å†åˆ©ç”¨ï¼‰
        displaySearchResult(formattedData);
        
    } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

// é¸æŠã—ãŸçµæœã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
async function exportSelectedResults() {
    const selectedIds = Array.from(document.querySelectorAll('.history-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹çµæœã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const format = confirm('CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§JSONå½¢å¼ï¼‰') ? 'csv' : 'json';
    
    try {
        const response = await fetch(`/rag/export-searches?result_ids=${selectedIds.join(',')}&format=${format}`);
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `search_results.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // BootstrapãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof bootstrap !== 'undefined') {
        console.log('Bootstrap loaded successfully');
    } else {
        console.error('Bootstrap not loaded');
    }
    
    // æ¤œç´¢å±¥æ­´ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸã¨ãã«è‡ªå‹•çš„ã«å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
    const historyTab = document.querySelector('a[href="#history"]');
    if (historyTab) {
        historyTab.addEventListener('shown.bs.tab', function() {
            loadSearchHistory();
        });
    }
});

// æ¤œç´¢çµæœè¡¨ç¤ºé–¢æ•°ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰
function displaySearchResult(data) {
    const resultDiv = document.getElementById('searchResult');
    const formattedAnswer = data.answer.replace(/\n/g, '<br>');
    
    let html = '<div class="card mt-3">';
    html += '<div class="card-body">';
    html += '<h4>ğŸ’¡ å›ç­”</h4>';
    html += `<div class="answer-content" style="white-space: pre-wrap; line-height: 1.6;">${formattedAnswer}</div>`;
    
    // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã®è¡¨ç¤º
    if (data.confidence_score !== undefined) {
        const confidence = (data.confidence_score * 100).toFixed(1);
        html += `<div class="mt-3">`;
        html += `<span class="badge bg-info">ä¿¡é ¼åº¦: ${confidence}%</span>`;
        if (data.metadata && data.metadata.fallback) {
            html += ` <span class="badge bg-warning">Fallback: ${data.metadata.fallback}</span>`;
        }
        html += `</div>`;
    }
    
    // å¼•ç”¨å…ƒã®è¡¨ç¤º
    if (data.citations && data.citations.length > 0) {
        html += '<h5 class="mt-4">ğŸ“š å¼•ç”¨ãƒ»å‚è€ƒè³‡æ–™</h5>';
        html += '<div class="citations-list">';
        data.citations.forEach(cite => {
            html += '<div class="card mb-2">';
            html += '<div class="card-body" style="padding: 10px;">';
            html += `<strong>[å‡ºå…¸: ${cite.source || 'ä¸æ˜'}]</strong><br>`;
            html += `<small>${cite.text}</small>`;
            if (cite.score !== undefined) {
                html += `<br><span class="badge bg-secondary">ã‚¹ã‚³ã‚¢: ${cite.score.toFixed(3)}</span>`;
            }
            html += '</div></div>';
        });
        html += '</div>';
    }
    
    // æ¤œç´¢çµæœã‚½ãƒ¼ã‚¹
    if (data.sources && data.sources.length > 0) {
        html += '<h5 class="mt-4">ğŸ” æ¤œç´¢çµæœè©³ç´°</h5>';
        html += '<table class="table table-sm">';
        html += '<thead><tr><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>ã‚¹ã‚³ã‚¢</th></tr></thead>';
        html += '<tbody>';
        data.sources.forEach(source => {
            const score = source.score !== undefined ? source.score.toFixed(3) : 'N/A';
            html += `<tr>`;
            html += `<td>${source.title || source.metadata?.title || 'ä¸æ˜'}</td>`;
            html += `<td>${score}</td>`;
            html += `</tr>`;
        });
        html += '</tbody></table>';
    }
    
    // å‡¦ç†æ™‚é–“
    if (data.processing_time) {
        html += `<div class="text-muted mt-3">å‡¦ç†æ™‚é–“: ${data.processing_time.toFixed(2)}ç§’</div>`;
    }
    
    // ä¿å­˜ãƒœã‚¿ãƒ³
    html += '<div class="mt-3">';
    html += '<button class="btn btn-success" onclick="saveSearchResult()">ğŸ’¾ æ¤œç´¢çµæœã‚’ä¿å­˜</button>';
    html += ' <button class="btn btn-info" onclick="showSearchHistory()">ğŸ“‹ æ¤œç´¢å±¥æ­´ã‚’è¡¨ç¤º</button>';
    html += '</div>';
    
    html += '</div></div>';
    
    window.lastSearchResult = data;
    resultDiv.innerHTML = html;
}

// æ¤œç´¢å±¥æ­´ã‚¿ãƒ–ç”¨ã®é–¢æ•°
let currentHistoryPage = 1;
let currentTagFilter = '';

async function loadSearchHistory(page = 1, tag = '') {
    const historyDiv = document.getElementById('historyList');
    historyDiv.innerHTML = '<div class="alert alert-info">èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    currentHistoryPage = page;
    currentTagFilter = tag || document.getElementById('tagFilter')?.value || '';
    
    try {
        let url = `/rag/search-history?page=${page}&limit=10`;
        if (currentTagFilter) {
            url += `&tag=${encodeURIComponent(currentTagFilter)}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.ok) {
            displayHistoryList(data);
            updateTagFilter(data.results);
        } else {
            throw new Error(data.detail || 'å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        historyDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

function displayHistoryList(data) {
    const historyDiv = document.getElementById('historyList');
    
    if (data.results.length === 0) {
        historyDiv.innerHTML = '<div class="text-muted">ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    
    let html = '<div class="table-responsive">';
    html += '<table class="table table-hover">';
    html += '<thead><tr>';
    html += '<th>ä¿å­˜å</th>';
    html += '<th>ã‚¯ã‚¨ãƒª</th>';
    html += '<th>ä¿¡é ¼åº¦</th>';
    html += '<th>ä¿å­˜æ—¥æ™‚</th>';
    html += '<th>æ“ä½œ</th>';
    html += '</tr></thead>';
    html += '<tbody>';
    
    data.results.forEach(result => {
        html += `<tr>`;
        html += `<td>${result.metadata?.name || '-'}</td>`;
        html += `<td title="${result.query}">${result.query.substring(0, 50)}${result.query.length > 50 ? '...' : ''}</td>`;
        html += `<td><span class="badge bg-info">${(result.confidence_score * 100).toFixed(1)}%</span></td>`;
        html += `<td><small>${new Date(result.saved_at).toLocaleString('ja-JP', { 
            timeZone: 'Asia/Tokyo',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        })}</small></td>`;
        html += `<td>`;
        html += `<button class="btn btn-sm btn-info me-1" onclick="viewSavedResultInTab('${result.id}')">è¡¨ç¤º</button>`;
        html += `<button class="btn btn-sm btn-danger" onclick="deleteSearchResult('${result.id}')" title="å‰Šé™¤">`;
        html += `<i class="bi bi-trash"></i>`;
        html += `</button>`;
        html += `</td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    historyDiv.innerHTML = html;
}

function updateTagFilter(results) {
    const tagSelect = document.getElementById('tagFilter');
    const existingTags = new Set();
    
    results.forEach(result => {
        const tags = result.metadata?.tags || [];
        tags.forEach(tag => existingTags.add(tag));
    });
    
    const currentValue = tagSelect.value;
    tagSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
    
    existingTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        if (tag === currentValue) {
            option.selected = true;
        }
        tagSelect.appendChild(option);
    });
}

async function viewSavedResultInTab(resultId) {
    try {
        const response = await fetch(`/rag/search-result/${resultId}`);
        const data = await response.json();
        
        // æ¤œç´¢ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
        const searchTab = document.querySelector('a[href="#search"]');
        const tab = new bootstrap.Tab(searchTab);
        tab.show();
        
        // çµæœã‚’è¡¨ç¤º
        const formattedData = {
            query: data.query,
            answer: data.answer,
            citations: data.citations,
            sources: data.sources,
            confidence_score: data.confidence_score,
            processing_time: data.metadata?.processing_time || 0,
            metadata: data.metadata || {}
        };
        
        displaySearchResult(formattedData);
        
    } catch (error) {
        alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }
}

async function exportAllHistory() {
    try {
        const response = await fetch('/rag/search-history?limit=1000');
        const data = await response.json();
        
        if (data.results.length === 0) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const format = confirm('CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§JSONå½¢å¼ï¼‰') ? 'csv' : 'json';
        const allIds = data.results.map(r => r.id).join(',');
        
        const exportResponse = await fetch(`/rag/export-searches?result_ids=${allIds}&format=${format}`);
        const blob = await exportResponse.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `all_search_history.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    }
}

// æ¤œç´¢çµæœã‚’å‰Šé™¤
async function deleteSearchResult(resultId) {
    if (!confirm('ã“ã®æ¤œç´¢çµæœã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/rag/search-history/${resultId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // å±¥æ­´ãƒªã‚¹ãƒˆã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            loadSearchHistory(currentHistoryPage, currentTagFilter);
            showNotification('æ¤œç´¢çµæœã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        } else {
            const data = await response.json();
            console.error('Delete error response:', data);
            throw new Error(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showNotification(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'danger');
    }
}

// å…¨ã¦ã®æ¤œç´¢å±¥æ­´ã‚’å‰Šé™¤
async function clearAllSearchHistory() {
    if (!confirm('ã™ã¹ã¦ã®æ¤œç´¢å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch('/rag/search-history/clear', {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadSearchHistory(1, '');
            showNotification('ã™ã¹ã¦ã®æ¤œç´¢å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        } else {
            const data = await response.json();
            throw new Error(data.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        showNotification(`å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'danger');
    }
}

// é€šçŸ¥ã‚’è¡¨ç¤º
function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// æ–‡æ›¸ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
async function loadDocumentCheckboxList() {
    const listDiv = document.getElementById('documentCheckboxList');
    if (!listDiv) return;
    
    try {
        const response = await fetch('/rag/documents');
        const data = await response.json();
        
        if (response.ok && data.documents) {
            if (data.documents.length === 0) {
                listDiv.innerHTML = '<div class="col-12"><div class="alert alert-warning">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡æ›¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div></div>';
                return;
            }
            
            let html = '';
            data.documents.forEach((doc, index) => {
                const docId = doc.id || doc.filename?.replace('.pdf', '');
                const title = doc.title || doc.filename || 'Untitled';
                const truncatedTitle = title.length > 30 ? title.substring(0, 30) + '...' : title;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-2">
                        <div class="form-check">
                            <input class="form-check-input document-checkbox" 
                                   type="checkbox" 
                                   value="${docId}" 
                                   id="doc_${index}"
                                   checked>
                            <label class="form-check-label" for="doc_${index}" title="${title}">
                                ${truncatedTitle}
                            </label>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            
            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const selectAllCheckbox = document.getElementById('selectAllDocuments');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('.document-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
            }
            
            // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´æ™‚ã«å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            document.querySelectorAll('.document-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const allCheckboxes = document.querySelectorAll('.document-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.document-checkbox:checked');
                    const selectAllCheckbox = document.getElementById('selectAllDocuments');
                    
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
                        selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
                    }
                });
            });
        }
    } catch (error) {
        console.error('æ–‡æ›¸ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        listDiv.innerHTML = '<div class="col-12"><div class="alert alert-danger">æ–‡æ›¸ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div></div>';
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', () => {
    // RAGãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿å®Ÿè¡Œ
    loadFinetunedModels();
    loadCurrentSettings();
    loadDocumentCheckboxList();  // æ–‡æ›¸ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
});
</script>
{% endblock %}